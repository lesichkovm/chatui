(()=>{var _=class{constructor(e){this.serverUrl=e.serverUrl,this.debug=e.debug||!1}getSessionKey(){return localStorage.getItem("chat_session_key")||""}setSessionKey(e){localStorage.setItem("chat_session_key",e)}isTestEnvironment(){return typeof window<"u"&&window.location&&window.location.hostname==="localhost"&&window.location.port==="32000"}performHandshake(e){if(this.isTestEnvironment()){this.setSessionKey("test-session-key"),e&&e();return}let t="handshakeCallback_"+Date.now(),a=`${this.serverUrl}/api/handshake?callback=${t}`;this._injectScript(a,t,i=>{i.status==="success"&&(this.setSessionKey(i.session_key),e&&e())})}connect(e){if(this.isTestEnvironment())return;let t=this.getSessionKey(),a="connectCallback_"+Date.now(),i=`${this.serverUrl}/api/messages?callback=${a}&type=connect&session_key=${encodeURIComponent(t)}`;this._injectScript(i,a,s=>{e&&(s.widget?e(s.text,"bot",s.widget):e(s.text,"bot"))})}sendMessage(e,t){if(this.isTestEnvironment())return;let a=this.getSessionKey(),i="chatCallback_"+Date.now(),s=`${this.serverUrl}/api/messages?callback=${i}&message=${encodeURIComponent(e)}&type=message&session_key=${encodeURIComponent(a)}`;this._injectScript(s,i,n=>{t&&(n.widget?t(n.text,"bot",n.widget):t(n.text,"bot"))})}_injectScript(e,t,a){let i=document.createElement("script");i.src=e,i.onerror=()=>{console.error(`ChatWidget: Failed to load ${e}`),window[t]&&delete window[t],document.body.contains(i)&&document.body.removeChild(i)},window[t]=function(s){a(s),delete window[t],document.body.contains(i)&&document.body.removeChild(i)},document.body.appendChild(i)}};var U=class extends _{constructor(e){super(e),this.wsConnection=null,this.connectionType=this.detectConnectionType(e.serverUrl),this.messageQueue=[],this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=1e3}detectConnectionType(e){try{let t=new URL(e);if(t.protocol==="wss:"||t.protocol==="ws:")return"websocket";if(t.protocol==="https:"||t.protocol==="http:")return"jsonp"}catch{console.warn("ChatWidget: Invalid server URL, defaulting to JSONP")}return"jsonp"}performHandshake(e){this.connectionType==="websocket"?this.performWebSocketHandshake(e):super.performHandshake(e)}performWebSocketHandshake(e){if(this.isTestEnvironment()){this.setSessionKey("test-session-key"),e&&e();return}this.initWebSocket().then(()=>{this.wsConnection&&(this.wsConnection.send(JSON.stringify({type:"handshake",timestamp:Date.now()})),this.wsConnection.onmessage=t=>{let a=JSON.parse(t.data);a.type==="handshake"&&a.status==="success"&&(this.setSessionKey(a.session_key),e&&e())})}).catch(t=>{console.error("ChatWidget: WebSocket handshake failed",t)})}connect(e){this.connectionType==="websocket"?this.connectWebSocket(e):super.connect(e)}connectWebSocket(e){if(!this.isTestEnvironment()){if(this.wsConnection&&this.wsConnection.readyState===WebSocket.OPEN){this.wsConnection.send(JSON.stringify({type:"connect",session_key:this.getSessionKey(),timestamp:Date.now()})),this.wsConnection.onmessage=t=>{let a=JSON.parse(t.data);a.type==="message"?e&&(a.widget?e(a.text,"bot",a.widget):e(a.text,"bot")):a.type==="typing"?this.handleTypingIndicator(a):a.type==="read_receipt"&&this.handleReadReceipt(a)};return}this.initWebSocket().then(()=>{this.wsConnection.onmessage=t=>{let a=JSON.parse(t.data);a.type==="message"?e&&(a.widget?e(a.text,"bot",a.widget):e(a.text,"bot")):a.type==="typing"?this.handleTypingIndicator(a):a.type==="read_receipt"&&this.handleReadReceipt(a)}}).catch(t=>{console.error("ChatWidget: WebSocket connection failed",t)})}}sendMessage(e,t){this.connectionType==="websocket"?this.sendWebSocketMessage(e,t):super.sendMessage(e,t)}sendWebSocketMessage(e,t){this.isTestEnvironment()||(this.wsConnection&&this.wsConnection.readyState===WebSocket.OPEN?(this.wsConnection.send(JSON.stringify({type:"message",payload:e,session_key:this.getSessionKey(),timestamp:Date.now()})),t&&(this.wsConnection.onmessage=a=>{let i=JSON.parse(a.data);(i.type==="message"||i.type==="message:stream")&&(i.widget?t(i.text,"bot",i.widget):t(i.text,"bot"))})):(console.warn("ChatWidget: WebSocket not connected, queuing message"),this.messageQueue.push({message:e,onResponse:t})))}sendTypingIndicator(e){this.connectionType==="websocket"&&this.wsConnection?.readyState===WebSocket.OPEN&&this.wsConnection.send(JSON.stringify({type:"typing",payload:{typing:e},session_key:this.getSessionKey(),timestamp:Date.now()}))}sendReadReceipt(e){this.connectionType==="websocket"&&this.wsConnection?.readyState===WebSocket.OPEN&&this.wsConnection.send(JSON.stringify({type:"read_receipt",payload:{message_id:e},session_key:this.getSessionKey(),timestamp:Date.now()}))}initWebSocket(){return new Promise((e,t)=>{if(this.wsConnection?.readyState===WebSocket.OPEN){e();return}try{this.wsConnection=new WebSocket(this.serverUrl),this.wsConnection.onopen=()=>{this.reconnectAttempts=0,this.flushMessageQueue(),e()},this.wsConnection.onerror=a=>{console.error("ChatWidget: WebSocket error",a),t(a)},this.wsConnection.onclose=()=>{this.reconnectAttempts<this.maxReconnectAttempts&&setTimeout(()=>{this.reconnectAttempts++,this.initWebSocket()},this.reconnectDelay*this.reconnectAttempts)}}catch(a){t(a)}})}flushMessageQueue(){for(;this.messageQueue.length>0;){let{message:e,onResponse:t}=this.messageQueue.shift();this.sendWebSocketMessage(e,t)}}handleTypingIndicator(e){let t=new CustomEvent("chatwidget:typing",{detail:{typing:e.payload.typing}});window.dispatchEvent(t)}handleReadReceipt(e){let t=new CustomEvent("chatwidget:read_receipt",{detail:{message_id:e.payload.message_id}});window.dispatchEvent(t)}disconnect(){this.wsConnection&&(this.wsConnection.close(),this.wsConnection=null)}};function b(o,e){return o.replace(/^#/,"").replace(/../g,t=>("0"+Math.min(255,Math.max(0,parseInt(t,16)+e)).toString(16)).substr(-2)).replace(/^/,"#")}var l=class{constructor(e,t){this.widgetData=e,this.widgetId=t}createElement(){throw new Error("createElement() must be implemented by subclass")}handleInteraction(e){let t=new CustomEvent("widgetInteraction",{detail:{widgetId:this.widgetId,...e}});document.dispatchEvent(t)}validate(){return this.widgetData&&this.widgetData.type}};var x=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid buttons widget data");let e=document.createElement("div");if(e.className="widget",this.widgetData.type==="buttons"&&this.widgetData.options){let t=document.createElement("div");t.className="widget-buttons",this.widgetData.options.forEach(a=>{let i=document.createElement("button");i.className="widget-button",i.textContent=a.text,i.setAttribute("data-widget-id",this.widgetId),i.setAttribute("data-option-id",a.id),i.setAttribute("data-option-value",a.value),i.addEventListener("click",()=>{t.querySelectorAll(".widget-button").forEach(n=>{n.disabled=!0,n.classList.add("widget-button-disabled")}),this.handleInteraction({optionId:a.id,optionValue:a.value,optionText:a.text,widgetType:"buttons"})}),t.appendChild(i)}),e.appendChild(t)}return e}validate(){return super.validate()&&this.widgetData.type==="buttons"&&Array.isArray(this.widgetData.options)&&this.widgetData.options.length>0}};var v=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid select widget data");let e=document.createElement("div");if(e.className="widget",this.widgetData.type==="select"&&this.widgetData.options){let t=document.createElement("div");t.className="widget-select";let a=document.createElement("select");if(a.className="widget-select-element",a.setAttribute("data-widget-id",this.widgetId),this.widgetData.placeholder){let i=document.createElement("option");i.value="",i.textContent=this.widgetData.placeholder,i.disabled=!0,i.selected=!0,a.appendChild(i)}this.widgetData.options.forEach(i=>{let s=document.createElement("option");s.value=i.value,s.textContent=i.text,s.setAttribute("data-option-id",i.id),a.appendChild(s)}),a.addEventListener("change",()=>{let i=a.options[a.selectedIndex],s=this.widgetData.options.find(n=>n.id===i.getAttribute("data-option-id"));s&&(a.disabled=!0,a.classList.add("widget-select-disabled"),this.handleInteraction({optionId:s.id,optionValue:s.value,optionText:s.text,widgetType:"select"}))}),t.appendChild(a),e.appendChild(t)}return e}validate(){return super.validate()&&this.widgetData.type==="select"&&Array.isArray(this.widgetData.options)&&this.widgetData.options.length>0}};var y=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid input widget data");let e=document.createElement("div");if(e.className="widget",this.widgetData.type==="input"){let t=document.createElement("div");t.className="widget-input";let a=document.createElement("input");a.type=this.widgetData.inputType||"text",a.className="widget-input-element",a.placeholder=this.widgetData.placeholder||"Enter your response...",a.setAttribute("data-widget-id",this.widgetId);let i=document.createElement("button");i.className="widget-input-submit",i.textContent=this.widgetData.buttonText||"Submit";let s=()=>{let n=a.value.trim();n&&(a.disabled=!0,a.classList.add("widget-input-disabled"),i.disabled=!0,i.classList.add("widget-input-disabled"),this.handleInteraction({optionId:"input-submit",optionValue:n,optionText:n,widgetType:"input"}),a.value="")};i.addEventListener("click",s),a.addEventListener("keypress",n=>{n.key==="Enter"&&(n.preventDefault(),s())}),t.appendChild(a),t.appendChild(i),e.appendChild(t)}return e}validate(){return super.validate()&&this.widgetData.type==="input"}};var C=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid checkbox widget data");let e=document.createElement("div");if(e.className="widget",this.widgetData.type==="checkbox"&&this.widgetData.options){let t=document.createElement("div");t.className="widget-checkbox";let a=document.createElement("button");a.className="widget-checkbox-submit",a.textContent=this.widgetData.buttonText||"Submit",this.widgetData.options.forEach(s=>{let n=document.createElement("div");n.className="widget-checkbox-item";let r=document.createElement("input");r.type="checkbox",r.className="widget-checkbox-element",r.id=`checkbox-${this.widgetId}-${s.id}`,r.value=s.value,r.setAttribute("data-widget-id",this.widgetId),r.setAttribute("data-option-id",s.id),s.checked&&(r.checked=!0);let d=document.createElement("label");d.className="widget-checkbox-label",d.htmlFor=`checkbox-${this.widgetId}-${s.id}`,d.textContent=s.text,n.appendChild(r),n.appendChild(d),t.appendChild(n)});let i=()=>{let s=t.querySelectorAll(".widget-checkbox-element"),n=[];s.forEach(r=>{if(r.checked){let d=r.getAttribute("data-option-id"),c=this.widgetData.options.find(m=>m.id===d);c&&n.push({optionId:c.id,optionValue:c.value,optionText:c.text})}}),(n.length>0||this.widgetData.allowEmpty!==!1)&&(t.querySelectorAll(".widget-checkbox-element").forEach(d=>{d.disabled=!0,d.classList.add("widget-checkbox-disabled")}),a.disabled=!0,a.classList.add("widget-checkbox-disabled"),this.handleInteraction({selectedOptions:n,widgetType:"checkbox"}))};a.addEventListener("click",i),t.appendChild(a),e.appendChild(t)}return e}validate(){return super.validate()&&this.widgetData.type==="checkbox"&&Array.isArray(this.widgetData.options)&&this.widgetData.options.length>0}};var E=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid textarea widget data");let e=document.createElement("div");if(e.className="widget",this.widgetData.type==="textarea"){let t=document.createElement("div");t.className="widget-textarea";let a=document.createElement("textarea");a.className="widget-textarea-element",a.placeholder=this.widgetData.placeholder||"Enter your response...",a.rows=this.widgetData.rows||4,a.setAttribute("data-widget-id",this.widgetId),this.widgetData.maxLength&&(a.maxLength=this.widgetData.maxLength);let i=document.createElement("button");i.className="widget-textarea-submit",i.textContent=this.widgetData.buttonText||"Submit";let s=()=>{let n=a.value.trim();n&&(a.disabled=!0,a.classList.add("widget-textarea-disabled"),i.disabled=!0,i.classList.add("widget-textarea-disabled"),this.handleInteraction({optionId:"textarea-submit",optionValue:n,optionText:n,widgetType:"textarea"}),a.value="")};i.addEventListener("click",s),a.addEventListener("keydown",n=>{n.key==="Enter"&&n.ctrlKey&&(n.preventDefault(),s())}),t.appendChild(a),t.appendChild(i),e.appendChild(t)}return e}validate(){return super.validate()&&this.widgetData.type==="textarea"}};var k=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid slider widget data");let e=document.createElement("div");if(e.className="widget",this.widgetData.type==="slider"){let t=document.createElement("div");t.className="widget-slider";let a=document.createElement("label");a.className="widget-slider-label",a.textContent=this.widgetData.label||"Select a value";let i=document.createElement("div");i.className="widget-slider-wrapper";let s=document.createElement("input");s.type="range",s.className="widget-slider-element",s.min=this.widgetData.min||0,s.max=this.widgetData.max||100,s.step=this.widgetData.step||1,s.value=this.widgetData.defaultValue||Math.floor((s.min+s.max)/2),s.setAttribute("data-widget-id",this.widgetId);let n=document.createElement("div");n.className="widget-slider-value",n.textContent=s.value;let r=document.createElement("button");r.className="widget-slider-submit",r.textContent=this.widgetData.buttonText||"Submit",s.addEventListener("input",()=>{n.textContent=s.value});let d=()=>{let c=parseFloat(s.value);s.disabled=!0,s.classList.add("widget-slider-disabled"),r.disabled=!0,r.classList.add("widget-slider-disabled"),this.handleInteraction({optionId:"slider-submit",optionValue:c,optionText:c.toString(),widgetType:"slider"})};r.addEventListener("click",d),i.appendChild(s),i.appendChild(n),t.appendChild(a),t.appendChild(i),t.appendChild(r),e.appendChild(t)}return e}validate(){return super.validate()&&this.widgetData.type==="slider"&&typeof this.widgetData.min=="number"&&typeof this.widgetData.max=="number"&&this.widgetData.max>this.widgetData.min}};var D=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid rating widget data");let e=document.createElement("div");if(e.className="widget",this.widgetData.type==="rating"){let t=document.createElement("div");t.className="widget-rating";let a=document.createElement("div");a.className="widget-rating-label",a.textContent=this.widgetData.label||"Rate this";let i=document.createElement("div");i.className="widget-rating-stars";let s=this.widgetData.maxRating||5,n=this.widgetData.iconType||"stars";for(let r=1;r<=s;r++){let d=document.createElement("button");d.className="widget-rating-star",d.setAttribute("data-rating",r),d.setAttribute("data-widget-id",this.widgetId),n==="emojis"?d.textContent="\u2B50":d.innerHTML="\u2605",d.addEventListener("mouseenter",()=>{this.highlightStars(i,r)}),d.addEventListener("mouseleave",()=>{this.resetStars(i)}),d.addEventListener("click",()=>{this.selectRating(i,r),i.querySelectorAll(".widget-rating-star").forEach(m=>{m.disabled=!0,m.classList.add("widget-rating-disabled")}),this.handleInteraction({optionId:"rating-submit",optionValue:r,optionText:`${r} star${r>1?"s":""}`,widgetType:"rating"})}),i.appendChild(d)}t.appendChild(a),t.appendChild(i),e.appendChild(t)}return e}highlightStars(e,t){e.querySelectorAll(".widget-rating-star").forEach((i,s)=>{s<t?i.classList.add("widget-rating-star-hover"):i.classList.remove("widget-rating-star-hover")})}resetStars(e){e.querySelectorAll(".widget-rating-star").forEach(a=>{a.classList.remove("widget-rating-star-hover")})}selectRating(e,t){e.querySelectorAll(".widget-rating-star").forEach((i,s)=>{s<t?i.classList.add("widget-rating-star-selected"):i.classList.remove("widget-rating-star-selected")})}validate(){return super.validate()&&this.widgetData.type==="rating"&&typeof this.widgetData.maxRating=="number"&&this.widgetData.maxRating>0}};var S=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid toggle widget data");let e=document.createElement("div");if(e.className="widget",this.widgetData.type==="toggle"){let t=document.createElement("div");t.className="widget-toggle";let a=document.createElement("label");a.className="widget-toggle-label",a.textContent=this.widgetData.label||"Enable";let i=document.createElement("div");i.className="widget-toggle-wrapper";let s=document.createElement("input");s.type="checkbox",s.className="widget-toggle-input",s.setAttribute("data-widget-id",this.widgetId),this.widgetData.defaultValue===!0&&(s.checked=!0);let n=document.createElement("span");n.className="widget-toggle-slider";let r=document.createElement("button");r.className="widget-toggle-submit",r.textContent=this.widgetData.buttonText||"Submit";let d=()=>{let c=s.checked;s.disabled=!0,s.classList.add("widget-toggle-disabled"),r.disabled=!0,r.classList.add("widget-toggle-disabled"),this.handleInteraction({optionId:"toggle-submit",optionValue:c,optionText:c?"enabled":"disabled",widgetType:"toggle"})};r.addEventListener("click",d),i.appendChild(s),i.appendChild(n),t.appendChild(a),t.appendChild(i),t.appendChild(r),e.appendChild(t)}return e}validate(){return super.validate()&&this.widgetData.type==="toggle"}};var $=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid date widget data");let e=document.createElement("div");if(e.className="widget",this.widgetData.type==="date"){let t=document.createElement("div");t.className="widget-date";let a=document.createElement("label");a.className="widget-date-label",a.textContent=this.widgetData.label||"Select a date";let i=document.createElement("input");i.type="date",i.className="widget-date-element",i.setAttribute("data-widget-id",this.widgetId),this.widgetData.minDate&&(i.min=this.widgetData.minDate),this.widgetData.maxDate&&(i.max=this.widgetData.maxDate),this.widgetData.placeholder&&(i.placeholder=this.widgetData.placeholder);let s=document.createElement("button");s.className="widget-date-submit",s.textContent=this.widgetData.buttonText||"Submit";let n=()=>{let r=i.value;r&&(i.disabled=!0,i.classList.add("widget-date-disabled"),s.disabled=!0,s.classList.add("widget-date-disabled"),this.handleInteraction({optionId:"date-submit",optionValue:r,optionText:r,widgetType:"date"}))};s.addEventListener("click",n),i.addEventListener("keypress",r=>{r.key==="Enter"&&(r.preventDefault(),n())}),t.appendChild(a),t.appendChild(i),t.appendChild(s),e.appendChild(t)}return e}validate(){return super.validate()&&this.widgetData.type==="date"}};var T=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid tags widget data");let e=document.createElement("div");if(e.className="widget",this.widgetData.type==="tags"){let t=document.createElement("div");t.className="widget-tags";let a=document.createElement("label");a.className="widget-tags-label",a.textContent=this.widgetData.label||"Add tags";let i=document.createElement("div");i.className="widget-tags-input-wrapper";let s=document.createElement("div");s.className="widget-tags-display";let n=document.createElement("input");n.type="text",n.className="widget-tags-input",n.placeholder=this.widgetData.placeholder||"Type and press Enter to add tag",n.setAttribute("data-widget-id",this.widgetId);let r=document.createElement("ul");r.className="widget-tags-suggestions",r.style.display="none";let d=this.widgetData.maxTags||10,c=[],m=()=>{s.innerHTML="",c.forEach((p,g)=>{let h=document.createElement("span");h.className="widget-tag",h.textContent=p;let f=document.createElement("button");f.className="widget-tag-remove",f.textContent="\xD7",f.addEventListener("click",()=>{c.splice(g,1),m()}),h.appendChild(f),s.appendChild(h)})},w=p=>{if(!this.widgetData.suggestions||!p){r.style.display="none";return}let g=this.widgetData.suggestions.filter(h=>h.toLowerCase().includes(p.toLowerCase())&&!c.includes(h));g.length>0?(r.innerHTML="",g.forEach(h=>{let f=document.createElement("li");f.className="widget-tags-suggestion",f.textContent=h,f.addEventListener("click",()=>{c.length<d&&(c.push(h),m(),n.value="",r.style.display="none")}),r.appendChild(f)}),r.style.display="block"):r.style.display="none"};n.addEventListener("input",()=>{w(n.value)}),n.addEventListener("keydown",p=>{if(p.key==="Enter"){p.preventDefault();let g=n.value.trim();g&&c.length<d&&!c.includes(g)&&(c.push(g),m(),n.value="",r.style.display="none")}else p.key==="Backspace"&&!n.value&&c.length>0&&(c.pop(),m())});let u=document.createElement("button");u.className="widget-tags-submit",u.textContent=this.widgetData.buttonText||"Submit";let H=()=>{c.length>0&&(n.disabled=!0,n.classList.add("widget-tags-disabled"),u.disabled=!0,u.classList.add("widget-tags-disabled"),this.handleInteraction({optionId:"tags-submit",optionValue:c,optionText:c.join(", "),widgetType:"tags"}))};u.addEventListener("click",H),i.appendChild(s),i.appendChild(n),i.appendChild(r),t.appendChild(a),t.appendChild(i),t.appendChild(u),e.appendChild(t)}return e}validate(){return super.validate()&&this.widgetData.type==="tags"}};var N=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid file upload widget data");let e=document.createElement("div");if(e.className="widget",this.widgetData.type==="file"){let t=document.createElement("div");t.className="widget-file-upload";let a=document.createElement("label");a.className="widget-file-label",a.textContent=this.widgetData.label||"Upload a file";let i=document.createElement("div");i.className="widget-file-dropzone";let s=document.createElement("div");s.className="widget-file-dropzone-content",s.innerHTML=`
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        <p>Drag and drop files here or click to select</p>
      `;let n=document.createElement("input");n.type="file",n.className="widget-file-input",n.setAttribute("data-widget-id",this.widgetId),n.style.display="none",this.widgetData.accept&&(n.accept=this.widgetData.accept),this.widgetData.maxFiles&&(n.multiple=this.widgetData.maxFiles>1);let r=document.createElement("div");r.className="widget-file-list";let d=[],c=this.widgetData.maxFiles||1,m=this.widgetData.maxSize||10*1024*1024,w=()=>{r.innerHTML="",d.forEach((p,g)=>{let h=document.createElement("div");h.className="widget-file-item";let f=document.createElement("span");f.className="widget-file-name",f.textContent=p.name;let K=document.createElement("span");K.className="widget-file-size",K.textContent=this.formatFileSize(p.size);let O=document.createElement("button");O.className="widget-file-remove",O.textContent="\xD7",O.addEventListener("click",()=>{d.splice(g,1),w()}),h.appendChild(f),h.appendChild(K),h.appendChild(O),r.appendChild(h)})};i.addEventListener("click",()=>{n.click()}),i.addEventListener("dragover",p=>{p.preventDefault(),i.classList.add("widget-file-dropzone-active")}),i.addEventListener("dragleave",()=>{i.classList.remove("widget-file-dropzone-active")}),i.addEventListener("drop",p=>{p.preventDefault(),i.classList.remove("widget-file-dropzone-active");let g=Array.from(p.dataTransfer.files);this.addFiles(g)}),n.addEventListener("change",()=>{let p=Array.from(n.files);this.addFiles(p),n.value=""}),this.addFiles=p=>{p.forEach(g=>{if(!(d.length>=c)){if(g.size>m){alert(`File ${g.name} exceeds maximum size of ${this.formatFileSize(m)}`);return}d.some(h=>h.name===g.name)||d.push(g)}}),w()};let u=document.createElement("button");u.className="widget-file-submit",u.textContent=this.widgetData.buttonText||"Upload";let H=()=>{if(d.length>0){let p=d.map(h=>({name:h.name,size:h.size,type:h.type}));i.classList.add("widget-file-disabled"),u.disabled=!0,u.classList.add("widget-file-disabled");let g=d.map(h=>h.name).join(", ");this.handleInteraction({optionId:"file-upload",optionValue:p,optionText:g||`${d.length} file(s)`,widgetType:"file"})}};u.addEventListener("click",H),i.appendChild(s),t.appendChild(a),t.appendChild(i),t.appendChild(r),t.appendChild(u),t.appendChild(n),e.appendChild(t)}return e}formatFileSize(e){if(e===0)return"0 Bytes";let t=1024,a=["Bytes","KB","MB","GB"],i=Math.floor(Math.log(e)/Math.log(t));return Math.round(e/Math.pow(t,i)*100)/100+" "+a[i]}validate(){return super.validate()&&this.widgetData.type==="file"}};var L=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid color picker widget data");let e=document.createElement("div");if(e.className="widget",this.widgetData.type==="color"){let t=document.createElement("div");t.className="widget-color-picker";let a=document.createElement("label");a.className="widget-color-label",a.textContent=this.widgetData.label||"Select a color";let i=document.createElement("div");i.className="widget-color-wrapper";let s=document.createElement("input");s.type="color",s.className="widget-color-input",s.setAttribute("data-widget-id",this.widgetId),this.widgetData.defaultColor&&(s.value=this.widgetData.defaultColor);let n=document.createElement("div");n.className="widget-color-display",n.style.backgroundColor=s.value,n.textContent=s.value.toUpperCase();let r=document.createElement("div");r.className="widget-color-presets",this.widgetData.presetColors&&this.widgetData.presetColors.length>0&&this.widgetData.presetColors.forEach(m=>{let w=document.createElement("button");w.className="widget-color-preset",w.style.backgroundColor=m,w.setAttribute("data-color",m),w.addEventListener("click",()=>{s.value=m,n.style.backgroundColor=m,n.textContent=m.toUpperCase()}),r.appendChild(w)});let d=document.createElement("button");d.className="widget-color-submit",d.textContent=this.widgetData.buttonText||"Submit",s.addEventListener("input",()=>{n.style.backgroundColor=s.value,n.textContent=s.value.toUpperCase()});let c=()=>{let m=s.value;s.disabled=!0,s.classList.add("widget-color-disabled"),d.disabled=!0,d.classList.add("widget-color-disabled"),this.handleInteraction({optionId:"color-submit",optionValue:m,optionText:m.toUpperCase(),widgetType:"color"})};d.addEventListener("click",c),i.appendChild(s),i.appendChild(n),t.appendChild(a),t.appendChild(i),this.widgetData.presetColors&&this.widgetData.presetColors.length>0&&t.appendChild(r),t.appendChild(d),e.appendChild(t)}return e}validate(){return super.validate()&&this.widgetData.type==="color"}};var W=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid confirmation widget data");let e=document.createElement("div");if(e.className="widget",this.widgetData.type==="confirmation"){let t=document.createElement("div");t.className="widget-confirmation";let a=document.createElement("div");a.className="widget-confirmation-message",a.textContent=this.widgetData.message||"Are you sure?";let i=document.createElement("div");i.className="widget-confirmation-buttons";let s=document.createElement("button");s.className="widget-confirmation-cancel",s.textContent=this.widgetData.cancelText||"Cancel";let n=document.createElement("button");n.className="widget-confirmation-confirm",n.textContent=this.widgetData.confirmText||"Confirm";let r=()=>{s.disabled=!0,s.classList.add("widget-confirmation-disabled"),n.disabled=!0,n.classList.add("widget-confirmation-disabled"),this.handleInteraction({optionId:"confirmation-cancel",optionValue:!1,optionText:"cancelled",widgetType:"confirmation"})},d=()=>{s.disabled=!0,s.classList.add("widget-confirmation-disabled"),n.disabled=!0,n.classList.add("widget-confirmation-disabled"),this.handleInteraction({optionId:"confirmation-confirm",optionValue:!0,optionText:"confirmed",widgetType:"confirmation"})};s.addEventListener("click",r),n.addEventListener("click",d),i.appendChild(s),i.appendChild(n),t.appendChild(a),t.appendChild(i),e.appendChild(t)}return e}validate(){return super.validate()&&this.widgetData.type==="confirmation"&&this.widgetData.message}};var M=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid radio widget data");let e=document.createElement("div");if(e.className="widget",this.widgetData.type==="radio"&&this.widgetData.options){let t=document.createElement("div");t.className="widget-radio";let a=document.createElement("button");a.className="widget-radio-submit",a.textContent=this.widgetData.buttonText||"Submit",this.widgetData.options.forEach(s=>{let n=document.createElement("div");n.className="widget-radio-item";let r=document.createElement("input");r.type="radio",r.name=`radio-${this.widgetId}`,r.className="widget-radio-element",r.id=`radio-${this.widgetId}-${s.id}`,r.value=s.value,r.setAttribute("data-widget-id",this.widgetId),r.setAttribute("data-option-id",s.id),s.checked&&(r.checked=!0);let d=document.createElement("label");d.className="widget-radio-label",d.htmlFor=`radio-${this.widgetId}-${s.id}`,d.textContent=s.text,n.appendChild(r),n.appendChild(d),t.appendChild(n)});let i=()=>{let s=t.querySelector(".widget-radio-element:checked");if(s){let n=s.getAttribute("data-option-id"),r=this.widgetData.options.find(d=>d.id===n);r&&(t.querySelectorAll(".widget-radio-element").forEach(c=>{c.disabled=!0,c.classList.add("widget-radio-disabled")}),a.disabled=!0,a.classList.add("widget-radio-disabled"),this.handleInteraction({optionId:r.id,optionValue:r.value,optionText:r.text,widgetType:"radio"}))}};a.addEventListener("click",i),t.appendChild(a),e.appendChild(t)}return e}validate(){return super.validate()&&this.widgetData.type==="radio"&&Array.isArray(this.widgetData.options)&&this.widgetData.options.length>0}};var A=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid progress widget data");let e=document.createElement("div");if(e.className="widget",this.widgetData.type==="progress"){let t=document.createElement("div");t.className="widget-progress";let a=document.createElement("div");a.className="widget-progress-label",a.textContent=this.widgetData.label||"Progress";let i=document.createElement("div");i.className="widget-progress-bar-wrapper";let s=document.createElement("div");s.className="widget-progress-bar";let n=this.widgetData.value||0,r=this.widgetData.max||100,d=Math.min(Math.max(n/r*100,0),100);s.style.width=`${d}%`;let c=document.createElement("div");c.className="widget-progress-text",c.textContent=`${n} / ${r}`,this.widgetData.showPercentage!==!1&&(c.textContent+=` (${Math.round(d)}%)`),i.appendChild(s),t.appendChild(a),t.appendChild(i),t.appendChild(c),e.appendChild(t)}return e}validate(){return super.validate()&&this.widgetData.type==="progress"&&typeof this.widgetData.value=="number"&&typeof this.widgetData.max=="number"&&this.widgetData.max>0}};var B=class{static widgetTypes=new Map([["buttons",x],["select",v],["input",y],["checkbox",C],["textarea",E],["slider",k],["rating",D],["toggle",S],["date",$],["tags",T],["file",N],["color",L],["confirmation",W],["radio",M],["progress",A]]);static registerWidget(e,t){this.widgetTypes.set(e,t)}static createWidget(e,t){if(!e||!e.type)return console.warn("Invalid widget data:",e),null;let a=this.widgetTypes.get(e.type);if(!a)return console.warn(`Unsupported widget type: ${e.type}`),null;try{return new a(e,t)}catch(i){return console.error(`Error creating widget of type ${e.type}:`,i),null}}static getSupportedTypes(){return Array.from(this.widgetTypes.keys())}};function P(o,e){let t=document.createElement("style");t.id=`${o}-styles`,t.textContent=`
    /* Scope all styles to the widget ID */
    #${o} {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    /* Theme: Default - Light Mode */
    #${o}[data-theme="default"][data-mode="light"] {
      --chat-primary: #007bff;
      --chat-bg: #ffffff;
      --chat-surface: #f8f9fa;
      --chat-text: #212529;
      --chat-border: #e9ecef;
      --chat-primary-dark: ${b("#007bff",-20)};
    }

    /* Theme: Default - Dark Mode */
    #${o}[data-theme="default"][data-mode="dark"] {
      --chat-primary: #4dabf7;
      --chat-bg: #1a1a1a;
      --chat-surface: #2d2d2d;
      --chat-text: #ffffff;
      --chat-border: #404040;
      --chat-primary-dark: ${b("#4dabf7",-20)};
    }

    /* Theme: Branded - Light Mode */
    #${o}[data-theme="branded"][data-mode="light"] {
      --chat-primary: #6366f1;
      --chat-bg: #ffffff;
      --chat-surface: #f5f3ff;
      --chat-text: #1e1b4b;
      --chat-border: #e0e7ff;
      --chat-primary-dark: ${b("#6366f1",-20)};
    }

    /* Theme: Branded - Dark Mode */
    #${o}[data-theme="branded"][data-mode="dark"] {
      --chat-primary: #818cf8;
      --chat-bg: #0f172a;
      --chat-surface: #1e293b;
      --chat-text: #f1f5f9;
      --chat-border: #334155;
      --chat-primary-dark: ${b("#818cf8",-20)};
    }

    /* Scoped CSS Reset */
    #${o} * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      line-height: 1.5;
    }
    
    #${o} .button {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      background-color: var(--chat-primary);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease;
      position: fixed;
      z-index: 10000;
    }
    
    #${o} .button:hover {
      transform: scale(1.1);
      background-color: var(--chat-primary-dark);
    }
    
    #${o} .window {
      display: none;
      width: 350px;
      height: 500px;
      background: var(--chat-bg);
      border-radius: 12px;
      box-shadow: 0 5px 40px rgba(0, 0, 0, 0.16);
      flex-direction: column;
      overflow: hidden;
      position: fixed;
      z-index: 9998;
    }

    #${o}.fullpage {
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    #${o}.fullpage .window {
      position: relative;
      display: flex;
      width: 100%;
      height: 100%;
      border-radius: 0;
      box-shadow: none;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }
    
    #${o} .window-open {
      display: flex;
    }
    
    #${o} .header {
      padding: 16px;
      background: var(--chat-surface);
      border-bottom: 1px solid var(--chat-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    
    #${o} .header h3 {
      margin: 0;
      font-size: 16px;
      color: var(--chat-text);
    }
    
    #${o} .close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--chat-text);
      opacity: 0.6;
      padding: 0;
      line-height: 1;
      display: block;
    }
    
    #${o}.fullpage .close {
      display: none;
    }
    
    #${o} .messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }
    
    #${o} .message {
      max-width: 80%;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    #${o} .user-message {
      background: var(--chat-primary);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    
    #${o} .bot-message {
      background: var(--chat-surface);
      color: var(--chat-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    
    #${o} .input {
      padding: 16px;
      border-top: 1px solid var(--chat-border);
      display: flex;
      gap: 8px;
      align-items: flex-end;
      flex-shrink: 0;
      background: var(--chat-bg);
    }
    
    #${o} .textarea {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--chat-border);
      border-radius: 6px;
      font-size: 14px;
      outline: none;
      resize: none;
      min-height: 38px;
      max-height: 150px;
      font-family: inherit;
      line-height: 1.4;
      overflow-y: auto;
      background: var(--chat-bg);
      color: var(--chat-text);
    }
    
    #${o} .textarea:focus {
      border-color: var(--chat-primary);
    }
    
    #${o} .send {
      padding: 8px 16px;
      background: var(--chat-primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s ease;
      height: 38px;
      white-space: nowrap;
    }
    
    #${o} .send:hover {
      background: var(--chat-primary-dark);
    }
    
    #${o} .widget {
      margin-top: 8px;
      padding: 12px;
      background: var(--chat-surface);
      border-radius: 8px;
      border: 1px solid var(--chat-border);
    }
    
    #${o} .widget-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    #${o} .widget-button {
      padding: 8px 12px;
      background: var(--chat-bg);
      border: 1px solid var(--chat-border);
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      text-align: left;
      transition: all 0.2s ease;
      color: var(--chat-text);
    }
    
    #${o} .widget-button:hover {
      background: var(--chat-primary);
      color: white;
      border-color: var(--chat-primary);
    }
    
    #${o} .widget-button:active {
      transform: translateY(1px);
    }
    
    #${o} .widget-button:disabled,
    #${o} .widget-button-disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: var(--chat-surface);
      color: var(--chat-text);
      border-color: var(--chat-border);
    }
    
    #${o} .widget-button:disabled:hover,
    #${o} .widget-button-disabled:hover {
      background: var(--chat-surface);
      color: var(--chat-text);
      border-color: var(--chat-border);
      transform: none;
    }
    
    #${o} .widget-select {
      margin-top: 8px;
    }
    
    #${o} .widget-select-element {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--chat-border);
      border-radius: 6px;
      font-size: 14px;
      background: var(--chat-bg);
      color: var(--chat-text);
      outline: none;
      cursor: pointer;
    }
    
    #${o} .widget-select-element:focus {
      border-color: var(--chat-primary);
    }
    
    #${o} .widget-select-element:disabled,
    #${o} .widget-select-disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: var(--chat-surface);
      color: var(--chat-text);
    }
    
    #${o} .widget-select-element:disabled:hover,
    #${o} .widget-select-disabled:hover {
      background: var(--chat-surface);
      border-color: var(--chat-border);
    }
    
    #${o} .widget-rating {
      margin-top: 8px;
    }
    
    #${o} .widget-rating-label {
      font-size: 14px;
      margin-bottom: 8px;
      color: var(--chat-text);
    }
    
    #${o} .widget-rating-stars {
      display: flex;
      gap: 4px;
    }
    
    #${o} .widget-rating-star {
      background: var(--chat-bg);
      border: 1px solid var(--chat-border);
      border-radius: 4px;
      cursor: pointer;
      font-size: 24px;
      padding: 4px 8px;
      color: var(--chat-text);
      transition: all 0.2s ease;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 40px;
      min-height: 40px;
    }
    
    #${o} .widget-rating-star:hover,
    #${o} .widget-rating-star-hover {
      background: var(--chat-surface);
      border-color: var(--chat-primary);
      color: var(--chat-primary);
      transform: scale(1.05);
    }
    
    #${o} .widget-rating-star-selected {
      background: var(--chat-primary) !important;
      color: white !important;
      border-color: var(--chat-primary) !important;
    }
    
    #${o} .widget-rating-disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    #${o} .widget-input {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    #${o} .widget-input-element {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--chat-border);
      border-radius: 6px;
      font-size: 14px;
      background: var(--chat-bg);
      color: var(--chat-text);
      outline: none;
    }
    
    #${o} .widget-input-element:focus {
      border-color: var(--chat-primary);
    }
    
    #${o} .widget-input-submit {
      padding: 8px 16px;
      background: var(--chat-primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s ease;
    }
    
    #${o} .widget-input-submit:hover {
      background: var(--chat-primary-dark);
    }
    
    #${o} .widget-input-element:disabled,
    #${o} .widget-input-element.widget-input-disabled,
    #${o} .widget-input-submit:disabled,
    #${o} .widget-input-submit.widget-input-disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: var(--chat-surface);
      color: var(--chat-text);
      border-color: var(--chat-border);
    }
    
    #${o} .widget-input-element:disabled:hover,
    #${o} .widget-input-element.widget-input-disabled:hover,
    #${o} .widget-input-submit:disabled:hover,
    #${o} .widget-input-submit.widget-input-disabled:hover {
      background: var(--chat-surface);
      border-color: var(--chat-border);
    }
  `,document.head.appendChild(t)}function V(o,e){let{displayMode:t,position:a,title:i,targetSelector:s}=e,n=document.createElement("div");n.id=o,n.className=t;let r=document.createElement("div");r.className="window",r.id=`${o}-window`,t==="popup"&&(r.style.cssText=`
      ${a.includes("bottom")?"bottom: 20px;":"top: 20px;"}
      ${a.includes("right")?"right: 20px;":"left: 20px;"}
    `),r.innerHTML=`
    <div class="header" id="${o}-header">
      <h3>${i}</h3>
      ${t==="popup"?`<button type="button" class="close" id="${o}-close" aria-label="Close chat">\xD7</button>`:""}
    </div>
    <div class="messages" id="${o}-messages" role="log" aria-live="polite" aria-atomic="false"></div>
    <div class="input">
      <textarea class="textarea" id="${o}-input" placeholder="Type your message... (Shift+Enter for new line)" rows="1" aria-label="Type a message"></textarea>
      <button type="button" class="send" id="${o}-send" aria-label="Send message">Send</button>
    </div>
  `;let d=null;if(t==="popup"&&(d=document.createElement("button"),d.className="button",d.id=`${o}-button`,d.type="button",d.setAttribute("aria-label","Toggle chat window"),d.style.cssText=`
      ${a.includes("bottom")?"bottom: 20px;":"top: 20px;"}
      ${a.includes("right")?"right: 20px;":"left: 20px;"}
    `,d.innerHTML=`
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z" fill="white"/>
      </svg>
    `,n.appendChild(d)),n.appendChild(r),t==="fullpage"&&s){let c=document.querySelector(s);c?c.appendChild(n):(console.error(`Target element "${s}" not found`),document.body.appendChild(n))}else document.body.appendChild(n);return{container:n,chatWindow:r,chatButton:d}}function j(o,e,t,a,i=null){let s=document.createElement("div");s.className=`message ${t}-message`,s.id=`${a}-message-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;let n=document.createElement("div");if(n.innerHTML=e.replace(/\n/g,"<br>"),s.appendChild(n),i&&t==="bot"){let r=F(i,a);s.appendChild(r)}o.appendChild(s),o.scrollTop=o.scrollHeight}function F(o,e){let t=B.createWidget(o,e);return t?t.createElement():document.createComment(`Unsupported widget type: ${o?.type}`)}var I={default:{light:{primary:"#007bff",bg:"#ffffff",surface:"#f8f9fa",text:"#212529",border:"#e9ecef"},dark:{primary:"#4dabf7",bg:"#1a1a1a",surface:"#2d2d2d",text:"#ffffff",border:"#404040"}},branded:{light:{primary:"#6366f1",bg:"#ffffff",surface:"#f5f3ff",text:"#1e1b4b",border:"#e0e7ff"},dark:{primary:"#818cf8",bg:"#0f172a",surface:"#1e293b",text:"#f1f5f9",border:"#334155"}}},R=class{constructor(e,t){this.widgetId=e,this.scriptElement=t,this.storageKey=`chat-widget-${e}-theme`,this.modeStorageKey=`chat-widget-${e}-mode`}getThemeConfig(){let e=this.getTheme(),t=this.getMode(),a=this.getCustomColors(t),i=I[e]?.[t]||I.default[t];return{theme:e,mode:t,colors:{...i,...a}}}getTheme(){let e=localStorage.getItem(this.storageKey);if(e&&I[e])return e;if(this.scriptElement){let t=this.scriptElement.getAttribute("data-theme");if(t&&I[t])return t}return"default"}getMode(){let e=localStorage.getItem(this.modeStorageKey);if(e==="light"||e==="dark")return e;if(this.scriptElement){let t=this.scriptElement.getAttribute("data-theme-mode");if(t==="light"||t==="dark")return t;let a=this.scriptElement.getAttribute("data-mode");if(a==="light"||a==="dark")return a}return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}getCustomColors(e){if(!this.scriptElement)return{};let t={},a=e==="light"?"-light":"-dark",i={[`data-color${a}`]:"primary",[`data-bg-color${a}`]:"bg",[`data-surface-color${a}`]:"surface",[`data-text-color${a}`]:"text",[`data-border-color${a}`]:"border"},s={"data-color":"primary","data-bg-color":"bg","data-surface-color":"surface","data-text-color":"text","data-border-color":"border"};for(let[n,r]of Object.entries(i)){let d=this.scriptElement.getAttribute(n);d&&(t[r]=d)}for(let[n,r]of Object.entries(s)){let d=this.scriptElement.getAttribute(n);d&&!t[r]&&(t[r]=d)}return t}setTheme(e){if(!I[e]){console.warn(`Unknown theme: ${e}`);return}localStorage.setItem(this.storageKey,e)}setMode(e){if(e!=="light"&&e!=="dark"){console.warn(`Invalid mode: ${e}`);return}localStorage.setItem(this.modeStorageKey,e)}toggleMode(){let t=this.getMode()==="light"?"dark":"light";return this.setMode(t),t}watchSystemTheme(e){if(!window.matchMedia)return;let t=window.matchMedia("(prefers-color-scheme: dark)"),a=i=>{if(!localStorage.getItem(this.modeStorageKey)){let s=i.matches?"dark":"light";e(s)}};return t.addEventListener?t.addEventListener("change",a):t.addListener(a),()=>{t.removeEventListener?t.removeEventListener("change",a):t.removeListener(a)}}};var z=class{constructor(e){let t={},a=null;if(e instanceof HTMLElement&&e.tagName==="SCRIPT"){if(a=e,a._chatWidgetInitialized)return;a._chatWidgetInitialized=!0;let n=a.getAttribute("data-display")||null;t={id:a.id,displayMode:n,position:a.getAttribute("data-position"),primaryColor:a.getAttribute("data-color"),title:a.getAttribute("data-title"),targetSelector:a.getAttribute("data-target"),serverUrl:a.getAttribute("data-server-url")}}else t=e||{};this.scriptElement=a,this.widgetId=t.id||"chat-widget-"+Math.random().toString(36).substr(2,9);let i=t.primaryColor||t.color;this.themeManager=new R(this.widgetId,a);let s=this.themeManager.getThemeConfig();this.config={displayMode:t.displayMode||t.mode||"popup",position:t.position||"bottom-right",primaryColor:i||s.colors.primary,explicitColor:i,title:t.title||"Chat with us",targetSelector:t.targetSelector||t.target||null,serverUrl:t.serverUrl||"http://localhost:3000",theme:s.theme,themeMode:s.mode,themeColors:s.colors},this.api=new U({serverUrl:this.config.serverUrl}),this.state={isOpen:!1,messages:[]},this.init(),this.scriptElement&&(this.scriptElement._chatWidgetInstance=this)}init(){P(this.widgetId,this.config);let{container:e,chatWindow:t,chatButton:a}=V(this.widgetId,this.config);this.container=e,this.chatWindow=t,this.chatButton=a,this.container.setAttribute("data-theme",this.config.theme),this.container.setAttribute("data-mode",this.config.themeMode),this.applyCustomColors(),this.messagesContainer=this.chatWindow.querySelector(".messages"),this.textarea=this.chatWindow.querySelector(".textarea"),this.sendButton=this.chatWindow.querySelector(".send"),this.closeButton=this.chatWindow.querySelector(".close"),this.bindEvents(),this.api.performHandshake(),this.api.connect((i,s,n)=>this.addMessage(i,s,n)),document.addEventListener("widgetInteraction",i=>{i.detail.widgetId===this.widgetId&&this.handleWidgetInteraction(i.detail)}),this.themeManager.watchSystemTheme(i=>{this.setThemeMode(i)})}applyCustomColors(){if(this.scriptElement){let t=this.config.themeMode==="light"?"-light":"-dark",a={[`data-color${t}`]:"--chat-primary",[`data-bg-color${t}`]:"--chat-bg",[`data-surface-color${t}`]:"--chat-surface",[`data-text-color${t}`]:"--chat-text",[`data-border-color${t}`]:"--chat-border"},i={"data-color":"--chat-primary","data-bg-color":"--chat-bg","data-surface-color":"--chat-surface","data-text-color":"--chat-text","data-border-color":"--chat-border"};for(let[s,n]of Object.entries(a)){let r=this.scriptElement.getAttribute(s);r&&(this.container.style.setProperty(n,r),n==="--chat-primary"&&this.container.style.setProperty("--chat-primary-dark",b(r,-20)))}for(let[s,n]of Object.entries(i)){let r=this.scriptElement.getAttribute(s);r&&!this.container.style.getPropertyValue(n)&&(this.container.style.setProperty(n,r),n==="--chat-primary"&&this.container.style.setProperty("--chat-primary-dark",b(r,-20)))}}this.config.explicitColor&&!this.container.style.getPropertyValue("--chat-primary")&&(this.container.style.setProperty("--chat-primary",this.config.explicitColor),this.container.style.setProperty("--chat-primary-dark",b(this.config.explicitColor,-20)))}setState(e){this.state={...this.state,...e},this.render()}render(){this.state.isOpen?(this.chatWindow.classList.add("window-open"),this.chatButton&&(this._updateButtonPosition(!0),this.chatButton.style.display="none")):(this.chatWindow.classList.remove("window-open"),this.chatButton&&(this._updateButtonPosition(!1),this.chatButton.style.display="flex"))}bindEvents(){this.handlers={toggle:()=>this.toggle(),close:()=>this.close(),send:()=>this.sendMessage(),keypress:e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this.sendMessage())}},this.chatButton&&this.chatButton.addEventListener("click",this.handlers.toggle),this.closeButton&&this.closeButton.addEventListener("click",this.handlers.close),this.textarea.addEventListener("keypress",this.handlers.keypress),this.sendButton.addEventListener("click",this.handlers.send),this.setupTextareaAutoResize()}setupTextareaAutoResize(){this.textarea.style.height="auto",this.textarea.style.height=this.textarea.scrollHeight+"px";let e=new ResizeObserver(()=>{this.textarea.style.height="auto";let a=Math.min(this.textarea.scrollHeight,150);this.textarea.style.height=a+"px",this.textarea.style.overflowY=this.textarea.scrollHeight>150?"auto":"hidden"});e.observe(this.textarea),this.resizeObserver=e}toggle(){this.setState({isOpen:!this.state.isOpen})}open(){this.setState({isOpen:!0}),setTimeout(()=>{this.textarea&&this.textarea.focus()},100)}close(){this.setState({isOpen:!1})}_updateButtonPosition(e){let{position:t}=this.config;e?t.includes("bottom")&&t.includes("right")?this.chatButton.style.cssText="bottom: 520px; right: 20px;":t.includes("bottom")&&t.includes("left")?this.chatButton.style.cssText="bottom: 520px; left: 20px;":t.includes("top")&&t.includes("right")?this.chatButton.style.cssText="top: 20px; right: 380px;":t.includes("top")&&t.includes("left")&&(this.chatButton.style.cssText="top: 20px; left: 380px;"):this.chatButton.style.cssText=`
        ${t.includes("bottom")?"bottom: 20px;":"top: 20px;"}
        ${t.includes("right")?"right: 20px;":"left: 20px;"}
      `}sendMessage(e){let t=e||this.textarea.value.trim();t&&(this.addMessage(t,"user"),this.api.sendMessage(t,(a,i,s)=>this.addMessage(a,i,s)),e||(this.textarea.value="",this.textarea.style.height="auto"))}handleWidgetInteraction(e){let t=e.optionText;this.addMessage(t,"user"),this.api.sendMessage(e.optionValue,(a,i,s)=>this.addMessage(a,i,s))}addMessage(e,t,a=null){let i={text:e,sender:t,timestamp:Date.now(),widgetData:a};this.state.messages.push(i),j(this.messagesContainer,e,t,this.widgetId,a)}get ws(){return this.api.wsConnection}sendTypingIndicator(e){this.api.sendTypingIndicator&&this.api.sendTypingIndicator(e)}setTheme(e){this.themeManager.setTheme(e),this.container.setAttribute("data-theme",e),this.config.theme=e}setThemeMode(e){this.themeManager.setMode(e),this.container.setAttribute("data-mode",e),this.config.themeMode=e,this.applyCustomColors()}toggleThemeMode(){let e=this.themeManager.toggleMode();return this.container.setAttribute("data-mode",e),this.config.themeMode=e,this.applyCustomColors(),e}getThemeConfig(){return{theme:this.config.theme,mode:this.config.themeMode,colors:this.config.themeColors}}};window.createChatWidget=function(o){return new z(o)};window.ChatUI={init:function(o){return new z(o)}};document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll('script[id^="chat-widget"]').forEach(e=>{e.src&&e.src!==window.location.href||window.createChatWidget(e)})});var q=new MutationObserver(function(o){o.forEach(function(e){e.addedNodes.forEach(function(t){if(t.nodeName==="SCRIPT"&&t.id&&t.id.startsWith("chat-widget")){if(t.src&&t.src!==window.location.href)return;window.createChatWidget(t)}})})});q.observe(document.documentElement,{childList:!0,subtree:!0});document.currentScript&&document.currentScript.id&&document.currentScript.id.startsWith("chat-widget")&&window.createChatWidget(document.currentScript);})();
