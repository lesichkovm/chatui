(()=>{var H=class{constructor(t){this.serverUrl=t.serverUrl,this.debug=t.debug||!1}getSessionKey(){return localStorage.getItem("chat_session_key")||""}setSessionKey(t){localStorage.setItem("chat_session_key",t)}isTestEnvironment(){return typeof window<"u"&&window.location&&window.location.hostname==="localhost"&&window.location.port==="32000"}performHandshake(t){if(this.isTestEnvironment()){this.setSessionKey("test-session-key"),t&&t();return}let e="handshakeCallback_"+Date.now(),i=`${this.serverUrl}/api/handshake?callback=${e}`;this._injectScript(i,e,o=>{o.status==="success"&&(this.setSessionKey(o.session_key),t&&t())})}connect(t){if(this.isTestEnvironment())return;let e=this.getSessionKey(),i="connectCallback_"+Date.now(),o=`${this.serverUrl}/api/messages?callback=${i}&type=connect&session_key=${encodeURIComponent(e)}`;this._injectScript(o,i,r=>{t&&(r.widget?t(r.text,"bot",r.widget):t(r.text,"bot"))})}sendMessage(t,e){if(this.isTestEnvironment()){setTimeout(()=>{e&&e(`Test response to: ${t}`,"bot")},100);return}let i=this.getSessionKey(),o="chatCallback_"+Date.now(),r=`${this.serverUrl}/api/messages?callback=${o}&message=${encodeURIComponent(t)}&type=message&session_key=${encodeURIComponent(i)}`;this._injectScript(r,o,s=>{e&&(s.text!==void 0&&s.text!==null?s.widget?e(s.text,"bot",s.widget):e(s.text,"bot"):console.error("ChatWidget: Legacy API received response without text field",s))})}_injectScript(t,e,i){let o=document.createElement("script");o.src=t,o.onerror=()=>{console.error(`ChatWidget: Failed to load ${t}`),window[e]&&delete window[e],document.body.contains(o)&&document.body.removeChild(o)},window[e]=function(r){i(r),delete window[e],document.body.contains(o)&&document.body.removeChild(o)},document.body.appendChild(o)}};var F=class{constructor(t){this.serverUrl=t.serverUrl,this.debug=t.debug||!1,this.timeout=t.timeout||5e3}getSessionKey(){return localStorage.getItem("chat_session_key")||""}setSessionKey(t){localStorage.setItem("chat_session_key",t)}isTestEnvironment(){return typeof window<"u"&&window.location&&window.location.hostname==="localhost"&&window.location.port==="32000"}async _fetchWithTimeout(t,e={}){let i=new AbortController,o=setTimeout(()=>i.abort(),this.timeout);try{let r=await fetch(t,{...e,signal:i.signal,headers:{"Content-Type":"application/json",Accept:"application/json",...e.headers}});if(clearTimeout(o),!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);let s=r.headers.get("content-type");if(!s||!s.includes("application/json"))throw new Error("Invalid response content type. Expected JSON.");return await r.json()}catch(r){throw clearTimeout(o),r.name==="TypeError"&&r.message.includes("Failed to fetch")?new Error("CORS_ERROR: "+r.message):r.name==="AbortError"?new Error("TIMEOUT_ERROR: Request timed out"):r}}async performHandshake(t,e){if(this.isTestEnvironment()){this.setSessionKey("test-session-key"),t&&t();return}let i=`${this.serverUrl}/api/handshake`;try{let o=await this._fetchWithTimeout(i,{method:"POST",body:JSON.stringify({type:"handshake",timestamp:Date.now()})});if(o.status==="success")this.setSessionKey(o.session_key),t&&t();else throw new Error("Handshake failed: Invalid response status")}catch(o){this.debug&&console.error("ChatWidget: CORS handshake failed",o),e&&e(o)}}async connect(t,e){if(this.isTestEnvironment())return;let i=this.getSessionKey(),o=`${this.serverUrl}/api/messages`;try{let r=await this._fetchWithTimeout(o,{method:"POST",body:JSON.stringify({type:"connect",session_key:i,timestamp:Date.now()})});if(t){if(r.status==="success"&&r.text)r.widget?t(r.text,"bot",r.widget):t(r.text,"bot");else if(r.status==="error")throw new Error(r.message||"Server returned error response")}}catch(r){this.debug&&console.error("ChatWidget: CORS connect failed",r),e&&e(r)}}async sendMessage(t,e,i){if(this.isTestEnvironment()){setTimeout(()=>{e&&e(`Test response to: ${t}`,"bot")},100);return}let o=this.getSessionKey(),r=`${this.serverUrl}/api/messages`;try{let s=await this._fetchWithTimeout(r,{method:"POST",body:JSON.stringify({type:"message",message:t,session_key:o,timestamp:Date.now()})});if(e){if(s.status==="success"&&s.text)s.widget?e(s.text,"bot",s.widget):e(s.text,"bot");else if(s.status==="error")throw new Error(s.message||"Server returned error response")}}catch(s){this.debug&&console.error("ChatWidget: CORS sendMessage failed",s),i&&i(s)}}};var K=class extends H{constructor(t){super(t),this.config=t,this.serverUrl=t.serverUrl,this.debug=t.debug||!1,this.timeout=t.timeout||5e3,this.fallbackRetries=t.fallbackRetries||2,this.forceJsonP=t.forceJsonP||!1,this.preferJsonP=t.preferJsonP||!1,this.wsConnection=null,this.connectionType=this.detectConnectionType(t.serverUrl),this.messageQueue=[],this.reconnectAttempts=0,this.maxReconnectAttempts=5,this.reconnectDelay=1e3,this.fallbackAttempts=0,this.initializeApi()}initializeApi(){this.connectionType==="websocket"?this.apiType="websocket":this.forceJsonP||this.preferJsonP?this.apiType="jsonp":(this.corsApi=new F(this.config),this.apiType="cors")}detectConnectionType(t){try{let e=new URL(t);if(e.protocol==="wss:"||e.protocol==="ws:")return"websocket";if(e.protocol==="https:"||e.protocol==="http:")return"http"}catch{console.warn("ChatWidget: Invalid server URL, defaulting to HTTP")}return"http"}performHandshake(t,e){this.connectionType==="websocket"?this.performWebSocketHandshake(t,e):this.apiType==="cors"?this.performCorsHandshake(t,e):super.performHandshake(t)}performCorsHandshake(t,e){this.corsApi.performHandshake(()=>{this.setSessionKey(this.corsApi.getSessionKey()),t&&t()},i=>{this.shouldFallbackToJSONP(i)?(this.fallbackToJSONP(),super.performHandshake(t)):(console.error("ChatWidget: Handshake failed",i),e&&e(i))})}shouldFallbackToJSONP(t){if(this.fallbackAttempts>=this.fallbackRetries)return!1;let e=t.message;return e.includes("CORS_ERROR")||e.includes("Failed to fetch")||e.includes("Network request failed")}fallbackToJSONP(){this.fallbackAttempts++,this.apiType="jsonp",console.warn("ChatWidget: Falling back to JSONP due to CORS issues")}performWebSocketHandshake(t,e){if(this.isTestEnvironment()){this.setSessionKey("test-session-key"),t&&t();return}this.initWebSocket().then(()=>{this.wsConnection&&(this.wsConnection.send(JSON.stringify({type:"handshake",timestamp:Date.now()})),this.wsConnection.onmessage=i=>{let o=JSON.parse(i.data);o.type==="handshake"&&o.status==="success"&&(this.setSessionKey(o.session_key),t&&t())})}).catch(i=>{console.error("ChatWidget: WebSocket handshake failed",i),e&&e(i)})}connect(t){this.connectionType==="websocket"?this.connectWebSocket(t):this.apiType==="cors"?this.connectCors(t):super.connect(t)}connectCors(t){this.corsApi.connect((e,i,o)=>{t&&t(e,i,o)},e=>{this.shouldFallbackToJSONP(e)?(this.fallbackToJSONP(),super.connect(t)):console.error("ChatWidget: Connect failed",e)})}connectWebSocket(t){if(!this.isTestEnvironment()){if(this.wsConnection&&this.wsConnection.readyState===WebSocket.OPEN){this.wsConnection.send(JSON.stringify({type:"connect",session_key:this.getSessionKey(),timestamp:Date.now()})),this.wsConnection.onmessage=e=>{let i=JSON.parse(e.data);i.type==="message"?t&&(i.widget?t(i.text,"bot",i.widget):t(i.text,"bot")):i.type==="typing"?this.handleTypingIndicator(i):i.type==="read_receipt"&&this.handleReadReceipt(i)};return}this.initWebSocket().then(()=>{this.wsConnection.onmessage=e=>{let i=JSON.parse(e.data);i.type==="message"?t&&(i.widget?t(i.text,"bot",i.widget):t(i.text,"bot")):i.type==="typing"?this.handleTypingIndicator(i):i.type==="read_receipt"&&this.handleReadReceipt(i)}}).catch(e=>{console.error("ChatWidget: WebSocket connection failed",e)})}}sendMessage(t,e){this.connectionType==="websocket"?this.sendWebSocketMessage(t,e):this.apiType==="cors"?this.sendMessageCors(t,e):super.sendMessage(t,e)}sendMessageCors(t,e){this.corsApi.sendMessage(t,(i,o,r)=>{e&&e(i,o,r)},i=>{this.shouldFallbackToJSONP(i)?(this.fallbackToJSONP(),super.sendMessage(t,e)):console.error("ChatWidget: SendMessage failed",i)})}sendWebSocketMessage(t,e){this.isTestEnvironment()||(this.wsConnection&&this.wsConnection.readyState===WebSocket.OPEN?(this.wsConnection.send(JSON.stringify({type:"message",payload:t,session_key:this.getSessionKey(),timestamp:Date.now()})),e&&(this.wsConnection.onmessage=i=>{let o=JSON.parse(i.data);(o.type==="message"||o.type==="message:stream")&&(o.widget?e(o.text,"bot",o.widget):e(o.text,"bot"))})):(console.warn("ChatWidget: WebSocket not connected, queuing message"),this.messageQueue.push({message:t,onResponse:e})))}sendTypingIndicator(t){this.connectionType==="websocket"&&this.wsConnection?.readyState===WebSocket.OPEN&&this.wsConnection.send(JSON.stringify({type:"typing",payload:{typing:t},session_key:this.getSessionKey(),timestamp:Date.now()}))}sendReadReceipt(t){this.connectionType==="websocket"&&this.wsConnection?.readyState===WebSocket.OPEN&&this.wsConnection.send(JSON.stringify({type:"read_receipt",payload:{message_id:t},session_key:this.getSessionKey(),timestamp:Date.now()}))}initWebSocket(){return new Promise((t,e)=>{if(this.wsConnection?.readyState===WebSocket.OPEN){t();return}try{this.wsConnection=new WebSocket(this.serverUrl),this.wsConnection.onopen=()=>{this.reconnectAttempts=0,this.flushMessageQueue(),t()},this.wsConnection.onerror=i=>{console.error("ChatWidget: WebSocket error",i),e(i)},this.wsConnection.onclose=()=>{this.reconnectAttempts<this.maxReconnectAttempts&&setTimeout(()=>{this.reconnectAttempts++,this.initWebSocket()},this.reconnectDelay*this.reconnectAttempts)}}catch(i){e(i)}})}flushMessageQueue(){for(;this.messageQueue.length>0;){let{message:t,onResponse:e}=this.messageQueue.shift();this.sendWebSocketMessage(t,e)}}handleTypingIndicator(t){let e=new CustomEvent("chatwidget:typing",{detail:{typing:t.payload.typing}});window.dispatchEvent(e)}handleReadReceipt(t){let e=new CustomEvent("chatwidget:read_receipt",{detail:{message_id:t.payload.message_id}});window.dispatchEvent(e)}disconnect(){this.wsConnection&&(this.wsConnection.close(),this.wsConnection=null)}};function v(a,t){return a.replace(/^#/,"").replace(/../g,e=>("0"+Math.min(255,Math.max(0,parseInt(e,16)+t)).toString(16)).substr(-2)).replace(/^/,"#")}var l=class{constructor(t,e){this.widgetData=t,this.widgetId=e}createElement(){throw new Error("createElement() must be implemented by subclass")}handleInteraction(t){let e=new CustomEvent("widgetInteraction",{detail:{widgetId:this.widgetId,...t}});document.dispatchEvent(e)}validate(){return this.widgetData&&this.widgetData.type}};var g={BUTTONS:"buttons",SELECT:"select",INPUT:"input",PASSWORD:"password",CHECKBOX:"checkbox",TEXTAREA:"textarea",SLIDER:"slider",RATING:"rating",TOGGLE:"toggle",DATE:"date",TAGS:"tags",FILE_UPLOAD:"file_upload",COLOR_PICKER:"color_picker",CONFIRMATION:"confirmation",RADIO:"radio",PROGRESS:"progress"},w={FILE:"file",COLOR:"color"},G={[g.FILE_UPLOAD]:w.FILE,[g.COLOR_PICKER]:w.COLOR},se={[w.FILE]:g.FILE_UPLOAD,[w.COLOR]:g.COLOR_PICKER};var y=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid buttons widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type===g.BUTTONS&&this.widgetData.options){let e=document.createElement("div");e.className="widget-buttons",this.widgetData.options.forEach(i=>{let o=document.createElement("button");o.className="widget-button",o.textContent=i.text,o.setAttribute("data-widget-id",this.widgetId),o.setAttribute("data-option-id",i.id),o.setAttribute("data-option-value",i.value),o.addEventListener("click",()=>{e.querySelectorAll(".widget-button").forEach(s=>{s.disabled=!0,s.classList.add("widget-button-disabled")}),this.handleInteraction({optionId:i.id,optionValue:i.value,optionText:i.text,widgetType:"buttons"})}),e.appendChild(o)}),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type===g.BUTTONS&&Array.isArray(this.widgetData.options)&&this.widgetData.options.length>0}};var C=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid select widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="select"&&this.widgetData.options){let e=document.createElement("div");e.className="widget-select";let i=document.createElement("select");if(i.className="widget-select-element",i.setAttribute("data-widget-id",this.widgetId),this.widgetData.placeholder){let o=document.createElement("option");o.value="",o.textContent=this.widgetData.placeholder,o.disabled=!0,o.selected=!0,i.appendChild(o)}this.widgetData.options.forEach(o=>{let r=document.createElement("option");r.value=o.value,r.textContent=o.text,r.setAttribute("data-option-id",o.id),i.appendChild(r)}),i.addEventListener("change",()=>{let o=i.options[i.selectedIndex],r=this.widgetData.options.find(s=>s.id===o.getAttribute("data-option-id"));r&&(i.disabled=!0,i.classList.add("widget-select-disabled"),this.handleInteraction({optionId:r.id,optionValue:r.value,optionText:r.text,widgetType:"select"}))}),e.appendChild(i),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="select"&&Array.isArray(this.widgetData.options)&&this.widgetData.options.length>0}};var k=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid input widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="input"){let e=document.createElement("div");e.className="widget-input";let i=document.createElement("input");i.type=this.widgetData.inputType||"text",i.className="widget-input-element",i.placeholder=this.widgetData.placeholder||"Enter your response...",i.setAttribute("data-widget-id",this.widgetId);let o=document.createElement("button");o.className="widget-input-submit",o.textContent=this.widgetData.buttonText||"Submit";let r=()=>{let s=i.value.trim();s&&(i.disabled=!0,i.classList.add("widget-input-disabled"),o.disabled=!0,o.classList.add("widget-input-disabled"),this.handleInteraction({optionId:"input-submit",optionValue:s,optionText:s,widgetType:"input"}),i.value="")};o.addEventListener("click",r),i.addEventListener("keypress",s=>{s.key==="Enter"&&(s.preventDefault(),r())}),e.appendChild(i),e.appendChild(o),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="input"}};var E=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid password widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="password"){let e=document.createElement("div");e.className="widget-password";let i=document.createElement("div");i.className="widget-password-wrapper";let o=document.createElement("input");o.type="password",o.className="widget-password-element",o.placeholder=this.widgetData.placeholder||"Enter your password...",o.setAttribute("data-widget-id",this.widgetId),o.autocomplete=this.widgetData.autocomplete||"current-password";let r=document.createElement("button");r.type="button",r.className="widget-password-toggle",r.setAttribute("aria-label","Toggle password visibility"),r.innerHTML="\u{1F441}\uFE0F";let s=document.createElement("button");s.className="widget-password-submit",s.textContent=this.widgetData.buttonText||"Submit";let n=()=>{o.type==="password"?(o.type="text",r.innerHTML="\u{1F648}",r.setAttribute("aria-label","Hide password")):(o.type="password",r.innerHTML="\u{1F441}\uFE0F",r.setAttribute("aria-label","Show password"))},d=()=>{let c=o.value.trim();if(c){o.disabled=!0,o.classList.add("widget-password-disabled"),r.disabled=!0,r.classList.add("widget-password-disabled"),s.disabled=!0,s.classList.add("widget-password-disabled");let h=c;o.value="",this.handleInteraction({optionId:"password-submit",optionValue:h,optionText:"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",widgetType:"password"})}};r.addEventListener("click",n),s.addEventListener("click",d),o.addEventListener("keypress",c=>{c.key==="Enter"&&(c.preventDefault(),d())}),i.appendChild(o),i.appendChild(r),e.appendChild(i),e.appendChild(s),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="password"}};var $=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid checkbox widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="checkbox"&&this.widgetData.options){let e=document.createElement("div");e.className="widget-checkbox";let i=document.createElement("button");i.className="widget-checkbox-submit",i.textContent=this.widgetData.buttonText||"Submit",this.widgetData.options.forEach(r=>{let s=document.createElement("div");s.className="widget-checkbox-item";let n=document.createElement("input");n.type="checkbox",n.className="widget-checkbox-element",n.id=`checkbox-${this.widgetId}-${r.id}`,n.value=r.value,n.setAttribute("data-widget-id",this.widgetId),n.setAttribute("data-option-id",r.id),r.checked&&(n.checked=!0);let d=document.createElement("label");d.className="widget-checkbox-label",d.htmlFor=`checkbox-${this.widgetId}-${r.id}`,d.textContent=r.text,s.appendChild(n),s.appendChild(d),e.appendChild(s)});let o=()=>{let r=e.querySelectorAll(".widget-checkbox-element"),s=[];r.forEach(n=>{if(n.checked){let d=n.getAttribute("data-option-id"),c=this.widgetData.options.find(h=>h.id===d);c&&s.push({optionId:c.id,optionValue:c.value,optionText:c.text})}}),(s.length>0||this.widgetData.allowEmpty!==!1)&&(e.querySelectorAll(".widget-checkbox-element").forEach(d=>{d.disabled=!0,d.classList.add("widget-checkbox-disabled")}),i.disabled=!0,i.classList.add("widget-checkbox-disabled"),this.handleInteraction({selectedOptions:s,widgetType:"checkbox"}))};i.addEventListener("click",o),e.appendChild(i),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="checkbox"&&Array.isArray(this.widgetData.options)&&this.widgetData.options.length>0}};var T=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid textarea widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="textarea"){let e=document.createElement("div");e.className="widget-textarea";let i=document.createElement("textarea");i.className="widget-textarea-element",i.placeholder=this.widgetData.placeholder||"Enter your response...",i.rows=this.widgetData.rows||4,i.setAttribute("data-widget-id",this.widgetId),this.widgetData.maxLength&&(i.maxLength=this.widgetData.maxLength);let o=document.createElement("button");o.className="widget-textarea-submit",o.textContent=this.widgetData.buttonText||"Submit";let r=()=>{let s=i.value.trim();s&&(i.disabled=!0,i.classList.add("widget-textarea-disabled"),o.disabled=!0,o.classList.add("widget-textarea-disabled"),this.handleInteraction({optionId:"textarea-submit",optionValue:s,optionText:s,widgetType:"textarea"}),i.value="")};o.addEventListener("click",r),i.addEventListener("keydown",s=>{s.key==="Enter"&&s.ctrlKey&&(s.preventDefault(),r())}),e.appendChild(i),e.appendChild(o),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="textarea"}};var S=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid slider widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="slider"){let e=document.createElement("div");e.className="widget-slider";let i=document.createElement("label");i.className="widget-slider-label",i.textContent=this.widgetData.label||"Select a value";let o=document.createElement("div");o.className="widget-slider-wrapper";let r=document.createElement("input");r.type="range",r.className="widget-slider-element",r.min=this.widgetData.min||0,r.max=this.widgetData.max||100,r.step=this.widgetData.step||1,r.value=this.widgetData.defaultValue||Math.floor((r.min+r.max)/2),r.setAttribute("data-widget-id",this.widgetId);let s=document.createElement("div");s.className="widget-slider-value",s.textContent=r.value;let n=document.createElement("button");n.className="widget-slider-submit",n.textContent=this.widgetData.buttonText||"Submit",r.addEventListener("input",()=>{s.textContent=r.value});let d=()=>{let c=parseFloat(r.value);r.disabled=!0,r.classList.add("widget-slider-disabled"),n.disabled=!0,n.classList.add("widget-slider-disabled"),this.handleInteraction({optionId:"slider-submit",optionValue:c,optionText:c.toString(),widgetType:"slider"})};n.addEventListener("click",d),o.appendChild(r),o.appendChild(s),e.appendChild(i),e.appendChild(o),e.appendChild(n),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="slider"&&typeof this.widgetData.min=="number"&&typeof this.widgetData.max=="number"&&this.widgetData.max>this.widgetData.min}};var D=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid rating widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="rating"){let e=document.createElement("div");e.className="widget-rating";let i=document.createElement("div");i.className="widget-rating-label",i.textContent=this.widgetData.label||"Rate this";let o=document.createElement("div");o.className="widget-rating-stars";let r=this.widgetData.maxRating||5,s=this.widgetData.iconType||"stars";for(let n=1;n<=r;n++){let d=document.createElement("button");d.className="widget-rating-star",d.setAttribute("data-rating",n),d.setAttribute("data-widget-id",this.widgetId),s==="emojis"?d.textContent="\u2B50":d.innerHTML="\u2605",d.addEventListener("mouseenter",()=>{this.highlightStars(o,n)}),d.addEventListener("mouseleave",()=>{this.resetStars(o)}),d.addEventListener("click",()=>{this.selectRating(o,n),o.querySelectorAll(".widget-rating-star").forEach(h=>{h.disabled=!0,h.classList.add("widget-rating-disabled")}),this.handleInteraction({optionId:"rating-submit",optionValue:n,optionText:`${n} star${n>1?"s":""}`,widgetType:"rating"})}),o.appendChild(d)}e.appendChild(i),e.appendChild(o),t.appendChild(e)}return t}highlightStars(t,e){t.querySelectorAll(".widget-rating-star").forEach((o,r)=>{r<e?o.classList.add("widget-rating-star-hover"):o.classList.remove("widget-rating-star-hover")})}resetStars(t){t.querySelectorAll(".widget-rating-star").forEach(i=>{i.classList.remove("widget-rating-star-hover")})}selectRating(t,e){t.querySelectorAll(".widget-rating-star").forEach((o,r)=>{r<e?o.classList.add("widget-rating-star-selected"):o.classList.remove("widget-rating-star-selected")})}validate(){return super.validate()&&this.widgetData.type==="rating"&&typeof this.widgetData.maxRating=="number"&&this.widgetData.maxRating>0}};var N=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid toggle widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="toggle"){let e=document.createElement("div");e.className="widget-toggle";let i=document.createElement("label");i.className="widget-toggle-label",i.textContent=this.widgetData.label||"Enable";let o=document.createElement("div");o.className="widget-toggle-wrapper";let r=document.createElement("input");r.type="checkbox",r.className="widget-toggle-input",r.setAttribute("data-widget-id",this.widgetId),this.widgetData.defaultValue===!0&&(r.checked=!0);let s=document.createElement("span");s.className="widget-toggle-slider",s.addEventListener("click",()=>{r.checked=!r.checked});let n=document.createElement("button");n.className="widget-toggle-submit",n.textContent=this.widgetData.buttonText||"Submit";let d=()=>{let c=r.checked;r.disabled=!0,r.classList.add("widget-toggle-disabled"),n.disabled=!0,n.classList.add("widget-toggle-disabled"),this.handleInteraction({optionId:"toggle-submit",optionValue:c,optionText:c?"enabled":"disabled",widgetType:"toggle"})};n.addEventListener("click",d),o.appendChild(r),o.appendChild(s),e.appendChild(i),e.appendChild(o),e.appendChild(n),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="toggle"}};var L=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid date widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="date"){let e=document.createElement("div");e.className="widget-date";let i=document.createElement("label");i.className="widget-date-label",i.textContent=this.widgetData.label||"Select a date";let o=document.createElement("input");o.type="date",o.className="widget-date-element",o.setAttribute("data-widget-id",this.widgetId),this.widgetData.minDate&&(o.min=this.widgetData.minDate),this.widgetData.maxDate&&(o.max=this.widgetData.maxDate),this.widgetData.placeholder&&(o.placeholder=this.widgetData.placeholder);let r=document.createElement("button");r.className="widget-date-submit",r.textContent=this.widgetData.buttonText||"Submit";let s=()=>{let n=o.value;n&&(o.disabled=!0,o.classList.add("widget-date-disabled"),r.disabled=!0,r.classList.add("widget-date-disabled"),this.handleInteraction({optionId:"date-submit",optionValue:n,optionText:n,widgetType:"date"}))};r.addEventListener("click",s),o.addEventListener("keypress",n=>{n.key==="Enter"&&(n.preventDefault(),s())}),e.appendChild(i),e.appendChild(o),e.appendChild(r),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="date"}};var W=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid tags widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="tags"){let e=document.createElement("div");e.className="widget-tags";let i=document.createElement("label");i.className="widget-tags-label",i.textContent=this.widgetData.label||"Add tags";let o=document.createElement("div");o.className="widget-tags-input-wrapper";let r=document.createElement("div");r.className="widget-tags-display";let s=document.createElement("input");s.type="text",s.className="widget-tags-input",s.placeholder=this.widgetData.placeholder||"Type and press Enter to add tag",s.setAttribute("data-widget-id",this.widgetId);let n=document.createElement("ul");n.className="widget-tags-suggestions",n.style.display="none";let d=this.widgetData.maxTags||10,c=[],h=()=>{r.innerHTML="",c.forEach((m,u)=>{let p=document.createElement("span");p.className="widget-tag",p.textContent=m;let b=document.createElement("button");b.className="widget-tag-remove",b.textContent="\xD7",b.addEventListener("click",()=>{c.splice(u,1),h()}),p.appendChild(b),r.appendChild(p)})},x=m=>{if(!this.widgetData.suggestions||!m){n.style.display="none";return}let u=this.widgetData.suggestions.filter(p=>p.toLowerCase().includes(m.toLowerCase())&&!c.includes(p));u.length>0?(n.innerHTML="",u.forEach(p=>{let b=document.createElement("li");b.className="widget-tags-suggestion",b.textContent=p,b.addEventListener("click",()=>{c.length<d&&(c.push(p),h(),s.value="",n.style.display="none")}),n.appendChild(b)}),n.style.display="block"):n.style.display="none"};s.addEventListener("input",()=>{x(s.value)}),s.addEventListener("keydown",m=>{if(m.key==="Enter"){m.preventDefault();let u=s.value.trim();u&&c.length<d&&!c.includes(u)&&(c.push(u),h(),s.value="",n.style.display="none")}else m.key==="Backspace"&&!s.value&&c.length>0&&(c.pop(),h())});let f=document.createElement("button");f.className="widget-tags-submit",f.textContent=this.widgetData.buttonText||"Submit";let j=()=>{c.length>0&&(s.disabled=!0,s.classList.add("widget-tags-disabled"),f.disabled=!0,f.classList.add("widget-tags-disabled"),this.handleInteraction({optionId:"tags-submit",optionValue:c,optionText:c.join(", "),widgetType:"tags"}))};f.addEventListener("click",j),o.appendChild(r),o.appendChild(s),o.appendChild(n),e.appendChild(i),e.appendChild(o),e.appendChild(f),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="tags"}};var A=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid file upload widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type===w.FILE){let e=document.createElement("div");e.className="widget-file-upload";let i=document.createElement("label");i.className="widget-file-label",i.textContent=this.widgetData.label||"Upload a file";let o=document.createElement("div");o.className="widget-file-dropzone";let r=document.createElement("div");r.className="widget-file-dropzone-content",r.innerHTML=`
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        <p>Drag and drop files here or click to select</p>
      `;let s=document.createElement("input");s.type="file",s.className="widget-file-input",s.setAttribute("data-widget-id",this.widgetId),s.style.display="none",this.widgetData.accept&&(s.accept=this.widgetData.accept),this.widgetData.maxFiles&&(s.multiple=this.widgetData.maxFiles>1);let n=document.createElement("div");n.className="widget-file-list";let d=[],c=this.widgetData.maxFiles||1,h=this.widgetData.maxSize||10*1024*1024,x=()=>{n.innerHTML="",d.forEach((m,u)=>{let p=document.createElement("div");p.className="widget-file-item";let b=document.createElement("span");b.className="widget-file-name",b.textContent=m.name;let V=document.createElement("span");V.className="widget-file-size",V.textContent=this.formatFileSize(m.size);let U=document.createElement("button");U.className="widget-file-remove",U.textContent="\xD7",U.addEventListener("click",()=>{d.splice(u,1),x()}),p.appendChild(b),p.appendChild(V),p.appendChild(U),n.appendChild(p)})};o.addEventListener("click",()=>{s.click()}),o.addEventListener("dragover",m=>{m.preventDefault(),o.classList.add("widget-file-dropzone-active")}),o.addEventListener("dragleave",()=>{o.classList.remove("widget-file-dropzone-active")}),o.addEventListener("drop",m=>{m.preventDefault(),o.classList.remove("widget-file-dropzone-active");let u=Array.from(m.dataTransfer.files);this.addFiles(u)}),s.addEventListener("change",()=>{let m=Array.from(s.files);this.addFiles(m),s.value=""}),this.addFiles=m=>{m.forEach(u=>{if(!(d.length>=c)){if(u.size>h){alert(`File ${u.name} exceeds maximum size of ${this.formatFileSize(h)}`);return}d.some(p=>p.name===u.name)||d.push(u)}}),x()};let f=document.createElement("button");f.className="widget-file-submit",f.textContent=this.widgetData.buttonText||"Upload";let j=()=>{if(d.length>0){let m=d.map(p=>({name:p.name,size:p.size,type:p.type}));o.classList.add("widget-file-disabled"),f.disabled=!0,f.classList.add("widget-file-disabled");let u=d.map(p=>p.name).join(", ");this.handleInteraction({optionId:"file-upload",optionValue:m,optionText:u||`${d.length} file(s)`,widgetType:"file"})}};f.addEventListener("click",j),o.appendChild(r),e.appendChild(i),e.appendChild(o),e.appendChild(n),e.appendChild(f),e.appendChild(s),t.appendChild(e)}return t}formatFileSize(t){if(t===0)return"0 Bytes";let e=1024,i=["Bytes","KB","MB","GB"],o=Math.floor(Math.log(t)/Math.log(e));return Math.round(t/Math.pow(e,o)*100)/100+" "+i[o]}validate(){return super.validate()&&this.widgetData.type===w.FILE}};var M=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid color picker widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type===w.COLOR){let e=document.createElement("div");e.className="widget-color-picker";let i=document.createElement("label");i.className="widget-color-label",i.textContent=this.widgetData.label||"Select a color";let o=document.createElement("div");o.className="widget-color-wrapper";let r=document.createElement("input");r.type="color",r.className="widget-color-input",r.setAttribute("data-widget-id",this.widgetId),this.widgetData.defaultColor&&(r.value=this.widgetData.defaultColor);let s=document.createElement("div");s.className="widget-color-display",s.style.backgroundColor=r.value,s.textContent=r.value.toUpperCase();let n=document.createElement("div");n.className="widget-color-presets",this.widgetData.presetColors&&this.widgetData.presetColors.length>0&&this.widgetData.presetColors.forEach(h=>{let x=document.createElement("button");x.className="widget-color-preset",x.style.backgroundColor=h,x.setAttribute("data-color",h),x.addEventListener("click",()=>{r.value=h,s.style.backgroundColor=h,s.textContent=h.toUpperCase()}),n.appendChild(x)});let d=document.createElement("button");d.className="widget-color-submit",d.textContent=this.widgetData.buttonText||"Submit",r.addEventListener("input",()=>{s.style.backgroundColor=r.value,s.textContent=r.value.toUpperCase()});let c=()=>{let h=r.value;r.disabled=!0,r.classList.add("widget-color-disabled"),d.disabled=!0,d.classList.add("widget-color-disabled"),this.handleInteraction({optionId:"color-submit",optionValue:h,optionText:h.toUpperCase(),widgetType:"color"})};d.addEventListener("click",c),o.appendChild(r),o.appendChild(s),e.appendChild(i),e.appendChild(o),this.widgetData.presetColors&&this.widgetData.presetColors.length>0&&e.appendChild(n),e.appendChild(d),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type===w.COLOR}};var O=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid confirmation widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="confirmation"){let e=document.createElement("div");e.className="widget-confirmation";let i=document.createElement("div");i.className="widget-confirmation-message",i.textContent=this.widgetData.message||"Are you sure?";let o=document.createElement("div");o.className="widget-confirmation-buttons";let r=document.createElement("button");r.className="widget-confirmation-cancel",r.textContent=this.widgetData.cancelText||"Cancel";let s=document.createElement("button");s.className="widget-confirmation-confirm",s.textContent=this.widgetData.confirmText||"Confirm";let n=()=>{r.disabled=!0,r.classList.add("widget-confirmation-disabled"),s.disabled=!0,s.classList.add("widget-confirmation-disabled"),this.handleInteraction({optionId:"confirmation-cancel",optionValue:!1,optionText:"cancelled",widgetType:"confirmation"})},d=()=>{r.disabled=!0,r.classList.add("widget-confirmation-disabled"),s.disabled=!0,s.classList.add("widget-confirmation-disabled"),this.handleInteraction({optionId:"confirmation-confirm",optionValue:!0,optionText:"confirmed",widgetType:"confirmation"})};r.addEventListener("click",n),s.addEventListener("click",d),o.appendChild(r),o.appendChild(s),e.appendChild(i),e.appendChild(o),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="confirmation"&&this.widgetData.message}};var z=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid radio widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="radio"&&this.widgetData.options){let e=document.createElement("div");e.className="widget-radio";let i=document.createElement("button");i.className="widget-radio-submit",i.textContent=this.widgetData.buttonText||"Submit",this.widgetData.options.forEach(r=>{let s=document.createElement("div");s.className="widget-radio-item";let n=document.createElement("input");n.type="radio",n.name=`radio-${this.widgetId}`,n.className="widget-radio-element",n.id=`radio-${this.widgetId}-${r.id}`,n.value=r.value,n.setAttribute("data-widget-id",this.widgetId),n.setAttribute("data-option-id",r.id),r.checked&&(n.checked=!0);let d=document.createElement("label");d.className="widget-radio-label",d.htmlFor=`radio-${this.widgetId}-${r.id}`,d.textContent=r.text,s.appendChild(n),s.appendChild(d),e.appendChild(s)});let o=()=>{let r=e.querySelector(".widget-radio-element:checked");if(r){let s=r.getAttribute("data-option-id"),n=this.widgetData.options.find(d=>d.id===s);n&&(e.querySelectorAll(".widget-radio-element").forEach(c=>{c.disabled=!0,c.classList.add("widget-radio-disabled")}),i.disabled=!0,i.classList.add("widget-radio-disabled"),this.handleInteraction({optionId:n.id,optionValue:n.value,optionText:n.text,widgetType:"radio"}))}};i.addEventListener("click",o),e.appendChild(i),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="radio"&&Array.isArray(this.widgetData.options)&&this.widgetData.options.length>0}};var P=class extends l{createElement(){if(!this.validate())return document.createComment("Invalid progress widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="progress"){let e=document.createElement("div");e.className="widget-progress";let i=document.createElement("div");i.className="widget-progress-label",i.textContent=this.widgetData.label||"Progress";let o=document.createElement("div");o.className="widget-progress-bar-wrapper";let r=document.createElement("div");r.className="widget-progress-bar";let s=this.widgetData.value||0,n=this.widgetData.max||100,d=Math.min(Math.max(s/n*100,0),100);r.style.width=`${d}%`;let c=document.createElement("div");c.className="widget-progress-text",c.textContent=`${s} / ${n}`,this.widgetData.showPercentage!==!1&&(c.textContent+=` (${Math.round(d)}%)`),o.appendChild(r),e.appendChild(i),e.appendChild(o),e.appendChild(c),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="progress"&&typeof this.widgetData.value=="number"&&typeof this.widgetData.max=="number"&&this.widgetData.max>0}};var B=class{static widgetTypes=new Map([[g.BUTTONS,y],[g.SELECT,C],[g.INPUT,k],[g.PASSWORD,E],[g.CHECKBOX,$],[g.TEXTAREA,T],[g.SLIDER,S],[g.RATING,D],[g.TOGGLE,N],[g.DATE,L],[g.TAGS,W],[w.FILE,A],[w.COLOR,M],[g.CONFIRMATION,O],[g.RADIO,z],[g.PROGRESS,P]]);static registerWidget(t,e){this.widgetTypes.set(t,e)}static createWidget(t,e){if(!t||!t.type)return console.warn("Invalid widget data:",t),null;let i=G[t.type]||t.type,o=this.widgetTypes.get(i);if(!o)return console.warn(`Unsupported widget type: ${t.type} (mapped to: ${i})`),null;try{let r={...t,type:i};return new o(r,e)}catch(r){return console.error(`Error creating widget of type ${t.type}:`,r),null}}static getSupportedTypes(){return Array.from(this.widgetTypes.keys())}};function q(a,t){let e=document.createElement("style");e.id=`${a}-styles`,e.textContent=`
    /* Scope all styles to the widget ID */
    #${a} {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    /* Theme: Default - Light Mode */
    #${a}[data-theme="default"][data-mode="light"] {
      --chat-primary: #007bff;
      --chat-bg: #ffffff;
      --chat-surface: #f8f9fa;
      --chat-text: #212529;
      --chat-border: #e9ecef;
      --chat-primary-dark: ${v("#007bff",-20)};
    }

    /* Theme: Default - Dark Mode */
    #${a}[data-theme="default"][data-mode="dark"] {
      --chat-primary: #4dabf7;
      --chat-bg: #1a1a1a;
      --chat-surface: #2d2d2d;
      --chat-text: #ffffff;
      --chat-border: #404040;
      --chat-primary-dark: ${v("#4dabf7",-20)};
    }

    /* Theme: Branded - Light Mode */
    #${a}[data-theme="branded"][data-mode="light"] {
      --chat-primary: #6366f1;
      --chat-bg: #ffffff;
      --chat-surface: #f5f3ff;
      --chat-text: #1e1b4b;
      --chat-border: #e0e7ff;
      --chat-primary-dark: ${v("#6366f1",-20)};
    }

    /* Theme: Branded - Dark Mode */
    #${a}[data-theme="branded"][data-mode="dark"] {
      --chat-primary: #818cf8;
      --chat-bg: #0f172a;
      --chat-surface: #1e293b;
      --chat-text: #f1f5f9;
      --chat-border: #334155;
      --chat-primary-dark: ${v("#818cf8",-20)};
    }

    /* Scoped CSS Reset */
    #${a} * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      line-height: 1.5;
    }
    
    #${a} .button {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      background-color: var(--chat-primary);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease;
      position: fixed;
      z-index: 10000;
    }
    
    #${a} .button:hover {
      transform: scale(1.1);
      background-color: var(--chat-primary-dark);
    }
    
    #${a} .window {
      display: none;
      width: 350px;
      height: 500px;
      background: var(--chat-bg);
      border-radius: 12px;
      box-shadow: 0 5px 40px rgba(0, 0, 0, 0.16);
      flex-direction: column;
      overflow: hidden;
      position: fixed;
      z-index: 9998;
    }

    #${a}.fullpage {
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    #${a}.fullpage .window {
      position: relative;
      display: flex;
      width: 100%;
      height: 100%;
      border-radius: 0;
      box-shadow: none;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }
    
    #${a} .window-open {
      display: flex;
    }
    
    #${a} .header {
      padding: 16px;
      background: var(--chat-surface);
      border-bottom: 1px solid var(--chat-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    
    #${a} .header h3 {
      margin: 0;
      font-size: 16px;
      color: var(--chat-text);
    }
    
    #${a} .close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--chat-text);
      opacity: 0.6;
      padding: 0;
      line-height: 1;
      display: block;
    }
    
    #${a}.fullpage .close {
      display: none;
    }
    
    #${a} .messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }
    
    #${a} .message {
      max-width: 80%;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    #${a} .user-message {
      background: var(--chat-primary);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    
    #${a} .bot-message {
      background: var(--chat-surface);
      color: var(--chat-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    
    #${a} .input {
      padding: 16px;
      border-top: 1px solid var(--chat-border);
      display: flex;
      gap: 8px;
      align-items: flex-end;
      flex-shrink: 0;
      background: var(--chat-bg);
    }
    
    #${a} .textarea {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--chat-border);
      border-radius: 6px;
      font-size: 14px;
      outline: none;
      resize: none;
      min-height: 38px;
      max-height: 150px;
      font-family: inherit;
      line-height: 1.4;
      overflow-y: auto;
      background: var(--chat-bg);
      color: var(--chat-text);
    }
    
    #${a} .textarea:focus {
      border-color: var(--chat-primary);
    }
    
    #${a} .send {
      padding: 8px 16px;
      background: var(--chat-primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s ease;
      height: 38px;
      white-space: nowrap;
    }
    
    #${a} .send:hover {
      background: var(--chat-primary-dark);
    }
    
    #${a} .widget {
      margin-top: 8px;
      padding: 12px;
      background: var(--chat-surface);
      border-radius: 8px;
      border: 1px solid var(--chat-border);
    }
    
    #${a} .widget-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    #${a} .widget-button {
      padding: 8px 12px;
      background: var(--chat-bg);
      border: 1px solid var(--chat-border);
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      text-align: left;
      transition: all 0.2s ease;
      color: var(--chat-text);
    }
    
    #${a} .widget-button:hover {
      background: var(--chat-primary);
      color: white;
      border-color: var(--chat-primary);
    }
    
    #${a} .widget-button:active {
      transform: translateY(1px);
    }
    
    #${a} .widget-button:disabled,
    #${a} .widget-button-disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: var(--chat-surface);
      color: var(--chat-text);
      border-color: var(--chat-border);
    }
    
    #${a} .widget-button:disabled:hover,
    #${a} .widget-button-disabled:hover {
      background: var(--chat-surface);
      color: var(--chat-text);
      border-color: var(--chat-border);
      transform: none;
    }
    
    #${a} .widget-select {
      margin-top: 8px;
    }
    
    #${a} .widget-select-element {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--chat-border);
      border-radius: 6px;
      font-size: 14px;
      background: var(--chat-bg);
      color: var(--chat-text);
      outline: none;
      cursor: pointer;
    }
    
    #${a} .widget-select-element:focus {
      border-color: var(--chat-primary);
    }
    
    #${a} .widget-select-element:disabled,
    #${a} .widget-select-disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: var(--chat-surface);
      color: var(--chat-text);
    }
    
    #${a} .widget-select-element:disabled:hover,
    #${a} .widget-select-disabled:hover {
      background: var(--chat-surface);
      border-color: var(--chat-border);
    }
    
    #${a} .widget-rating {
      margin-top: 8px;
    }
    
    #${a} .widget-rating-label {
      font-size: 14px;
      margin-bottom: 8px;
      color: var(--chat-text);
    }
    
    #${a} .widget-rating-stars {
      display: flex;
      gap: 4px;
    }
    
    #${a} .widget-rating-star {
      background: var(--chat-bg);
      border: 1px solid var(--chat-border);
      border-radius: 4px;
      cursor: pointer;
      font-size: 24px;
      padding: 0px 10px 4px 10px;
      color: var(--chat-text);
      transition: all 0.2s ease;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 40px;
      min-height: 40px;
      vertical-align: middle;
      box-sizing: border-box;
    }
    
    #${a} .widget-rating-star:hover,
    #${a} .widget-rating-star-hover {
      background: var(--chat-surface);
      border-color: var(--chat-primary);
      color: var(--chat-primary);
      transform: scale(1.05);
    }
    
    #${a} .widget-rating-star-selected {
      background: var(--chat-primary) !important;
      color: white !important;
      border-color: var(--chat-primary) !important;
    }
    
    #${a} .widget-rating-disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    #${a} .widget-input {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    #${a} .widget-input-element {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--chat-border);
      border-radius: 6px;
      font-size: 14px;
      background: var(--chat-bg);
      color: var(--chat-text);
      outline: none;
    }
    
    #${a} .widget-input-element:focus {
      border-color: var(--chat-primary);
    }
    
    #${a} .widget-input-submit {
      padding: 8px 16px;
      background: var(--chat-primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s ease;
    }
    
    #${a} .widget-input-submit:hover {
      background: var(--chat-primary-dark);
    }
    
    #${a} .widget-input-element:disabled,
    #${a} .widget-input-element.widget-input-disabled,
    #${a} .widget-input-submit:disabled,
    #${a} .widget-input-submit.widget-input-disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: var(--chat-surface);
      color: var(--chat-text);
      border-color: var(--chat-border);
    }
    
    #${a} .widget-input-element:disabled:hover,
    #${a} .widget-input-element.widget-input-disabled:hover,
    #${a} .widget-input-submit:disabled:hover,
    #${a} .widget-input-submit.widget-input-disabled:hover {
      background: var(--chat-surface);
      border-color: var(--chat-border);
    }
    
    #${a} .widget-confirmation {
      margin-top: 8px;
    }
    
    #${a} .widget-confirmation-message {
      font-size: 14px;
      margin-bottom: 12px;
      color: var(--chat-text);
      line-height: 1.4;
    }
    
    #${a} .widget-confirmation-buttons {
      display: flex;
      gap: 8px;
      justify-content: space-between;
    }
    
    #${a} .widget-confirmation-cancel,
    #${a} .widget-confirmation-confirm {
      padding: 6px 12px;
      border: 1px solid var(--chat-border);
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
      background: var(--chat-bg);
      color: var(--chat-text);
      flex: 1;
      min-width: 80px;
    }
    
    #${a} .widget-confirmation-cancel:hover,
    #${a} .widget-confirmation-confirm:hover {
      background: var(--chat-surface);
      border-color: var(--chat-primary);
    }
    
    #${a} .widget-confirmation-confirm {
      background: var(--chat-primary);
      color: white;
      border-color: var(--chat-primary);
    }
    
    #${a} .widget-confirmation-confirm:hover {
      background: var(--chat-primary-dark);
      border-color: var(--chat-primary-dark);
    }
    
    #${a} .widget-confirmation-cancel:disabled,
    #${a} .widget-confirmation-confirm:disabled,
    #${a} .widget-confirmation-disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: var(--chat-surface);
      color: var(--chat-text);
      border-color: var(--chat-border);
    }
    
    #${a} .widget-confirmation-cancel:disabled:hover,
    #${a} .widget-confirmation-confirm:disabled:hover,
    #${a} .widget-confirmation-disabled:hover {
      background: var(--chat-surface);
      border-color: var(--chat-border);
    }
    
    #${a} .widget-checkbox {
      margin-top: 8px;
    }
    
    #${a} .widget-checkbox-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    
    #${a} .widget-checkbox-element {
      margin-right: 8px;
    }
    
    #${a} .widget-checkbox-submit {
      margin-top: 12px;
      padding: 8px 16px;
      background: var(--chat-primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s ease;
    }
    
    #${a} .widget-checkbox-submit:hover {
      background: var(--chat-primary-dark);
    }
    
    #${a} .widget-textarea {
      margin-top: 8px;
    }
    
    #${a} .widget-textarea-element {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--chat-border);
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      line-height: 1.4;
      resize: vertical;
      min-height: 80px;
      background: var(--chat-bg);
      color: var(--chat-text);
      outline: none;
    }
    
    #${a} .widget-textarea-element:focus {
      border-color: var(--chat-primary);
    }
    
    #${a} .widget-textarea-submit {
      margin-top: 8px;
      padding: 8px 16px;
      background: var(--chat-primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s ease;
    }
    
    #${a} .widget-textarea-submit:hover {
      background: var(--chat-primary-dark);
    }
    
    #${a} .widget-slider {
      margin-top: 8px;
    }
    
    #${a} .widget-slider-label {
      font-size: 14px;
      margin-bottom: 8px;
      color: var(--chat-text);
    }
    
    #${a} .widget-slider-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    #${a} .widget-slider-element {
      flex: 1;
      height: 6px;
      background: var(--chat-border);
      border-radius: 3px;
      outline: none;
      -webkit-appearance: none;
    }
    
    #${a} .widget-slider-element::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: var(--chat-primary);
      border-radius: 50%;
      cursor: pointer;
    }
    
    #${a} .widget-slider-element::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: var(--chat-primary);
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }
    
    #${a} .widget-slider-value {
      font-size: 14px;
      color: var(--chat-text);
      min-width: 40px;
      text-align: center;
    }
    
    #${a} .widget-slider-submit {
      margin-top: 12px;
      padding: 8px 16px;
      background: var(--chat-primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s ease;
    }
    
    #${a} .widget-slider-submit:hover {
      background: var(--chat-primary-dark);
    }
    
    #${a} .widget-toggle {
      margin-top: 8px;
    }
    
    #${a} .widget-toggle-label {
      font-size: 14px;
      margin-bottom: 8px;
      color: var(--chat-text);
    }
    
    #${a} .widget-toggle-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    #${a} .widget-toggle-input {
      display: none;
    }
    
    #${a} .widget-toggle-slider {
      position: relative;
      width: 50px;
      height: 26px;
      background: var(--chat-border);
      border-radius: 13px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    
    #${a} .widget-toggle-slider::before {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.2s ease;
    }
    
    #${a} .widget-toggle-input:checked + .widget-toggle-slider {
      background: var(--chat-primary);
    }
    
    #${a} .widget-toggle-input:checked + .widget-toggle-slider::before {
      transform: translateX(24px);
    }
    
    #${a} .widget-toggle-submit {
      margin-top: 12px;
      padding: 8px 16px;
      background: var(--chat-primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s ease;
    }
    
    #${a} .widget-toggle-submit:hover {
      background: var(--chat-primary-dark);
    }
    
    #${a} .widget-date {
      margin-top: 8px;
    }
    
    #${a} .widget-date-element {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--chat-border);
      border-radius: 6px;
      font-size: 14px;
      background: var(--chat-bg);
      color: var(--chat-text);
      outline: none;
    }
    
    #${a} .widget-date-element:focus {
      border-color: var(--chat-primary);
    }
    
    #${a} .widget-date-label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--chat-text);
    }
    
    #${a} .widget-date-submit {
      width: 100%;
      margin-top: 12px;
      padding: 8px 16px;
      background: var(--chat-primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s ease;
    }
    
    #${a} .widget-date-submit:hover:not(:disabled) {
      background: var(--chat-primary-dark);
    }
    
    #${a} .widget-date-element.widget-date-disabled,
    #${a} .widget-date-submit.widget-date-disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    #${a} .widget-tags {
      margin-top: 8px;
    }
    
    #${a} .widget-tags-label {
      font-size: 14px;
      margin-bottom: 8px;
      color: var(--chat-text);
    }
    
    #${a} .widget-tags-input-wrapper {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    #${a} .widget-tags-display {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }
    
    #${a} .widget-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: var(--chat-surface);
      border: 1px solid var(--chat-border);
      border-radius: 4px;
      font-size: 12px;
      color: var(--chat-text);
    }
    
    #${a} .widget-tag-remove {
      background: none;
      border: none;
      color: var(--chat-text);
      cursor: pointer;
      font-size: 14px;
      padding: 0;
      line-height: 1;
      opacity: 0.7;
    }
    
    #${a} .widget-tag-remove:hover {
      opacity: 1;
    }
    
    #${a} .widget-tags-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--chat-border);
      border-radius: 6px;
      font-size: 14px;
      background: var(--chat-bg);
      color: var(--chat-text);
      outline: none;
    }
    
    #${a} .widget-tags-input:focus {
      border-color: var(--chat-primary);
    }
    
    #${a} .widget-tags-suggestions {
      list-style: none;
      margin: 4px 0 0 0;
      padding: 0;
      border: 1px solid var(--chat-border);
      border-radius: 4px;
      background: var(--chat-bg);
      max-height: 120px;
      overflow-y: auto;
    }
    
    #${a} .widget-tags-suggestion {
      padding: 6px 12px;
      cursor: pointer;
      font-size: 14px;
      color: var(--chat-text);
    }
    
    #${a} .widget-tags-suggestion:hover {
      background: var(--chat-surface);
    }
    
    #${a} .widget-tags-submit {
      margin-top: 12px;
      padding: 8px 16px;
      background: var(--chat-primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s ease;
    }
    
    #${a} .widget-tags-submit:hover {
      background: var(--chat-primary-dark);
    }
    
    #${a} .widget-file {
      margin-top: 8px;
    }
    
    #${a} .widget-file-upload {
      border: 2px dashed var(--chat-border);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--chat-bg);
    }
    
    #${a} .widget-file-upload:hover {
      border-color: var(--chat-primary);
      background: var(--chat-surface);
    }
    
    #${a} .widget-file-upload.dragover {
      border-color: var(--chat-primary);
      background: var(--chat-surface);
    }
    
    #${a} .widget-file-input {
      display: none;
    }
    
    #${a} .widget-file-info {
      margin-top: 12px;
      font-size: 14px;
      color: var(--chat-text);
    }
    
    #${a} .widget-file-label {
      display: block;
      margin-bottom: 12px;
      font-size: 14px;
      font-weight: 500;
      color: var(--chat-text);
    }
    
    #${a} .widget-file-dropzone {
      position: relative;
    }
    
    #${a} .widget-file-dropzone-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      color: var(--chat-text);
    }
    
    #${a} .widget-file-dropzone-content svg {
      color: var(--chat-text);
      opacity: 0.6;
    }
    
    #${a} .widget-file-dropzone-active {
      border-color: var(--chat-primary) !important;
      background: var(--chat-surface) !important;
    }
    
    #${a} .widget-file-list {
      margin-top: 12px;
    }
    
    #${a} .widget-file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: var(--chat-surface);
      border: 1px solid var(--chat-border);
      border-radius: 6px;
      margin-bottom: 6px;
    }
    
    #${a} .widget-file-name {
      flex: 1;
      font-size: 14px;
      color: var(--chat-text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    #${a} .widget-file-size {
      font-size: 12px;
      color: var(--chat-text);
      opacity: 0.7;
      margin-left: 8px;
    }
    
    #${a} .widget-file-remove {
      background: none;
      border: none;
      color: var(--chat-text);
      cursor: pointer;
      font-size: 16px;
      padding: 4px;
      border-radius: 4px;
      margin-left: 8px;
      opacity: 0.6;
      transition: all 0.2s ease;
    }
    
    #${a} .widget-file-remove:hover {
      opacity: 1;
      background: var(--chat-border);
    }
    
    #${a} .widget-file-submit {
      width: 100%;
      margin-top: 12px;
      padding: 8px 16px;
      background: var(--chat-primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s ease;
    }
    
    #${a} .widget-file-submit:hover:not(:disabled) {
      background: var(--chat-primary-dark);
    }
    
    #${a} .widget-file-upload.widget-file-disabled,
    #${a} .widget-file-submit.widget-file-disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    #${a} .widget-color {
      margin-top: 8px;
    }
    
    #${a} .widget-color-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    #${a} .widget-color-element {
      width: 50px;
      height: 40px;
      border: 1px solid var(--chat-border);
      border-radius: 6px;
      cursor: pointer;
      padding: 2px;
      background: var(--chat-bg);
    }
    
    #${a} .widget-color-element::-webkit-color-swatch-wrapper {
      padding: 0;
    }
    
    #${a} .widget-color-element::-webkit-color-swatch {
      border: none;
      border-radius: 4px;
    }
    
    #${a} .widget-color-value {
      font-size: 14px;
      color: var(--chat-text);
      font-family: monospace;
    }
    
    #${a} .widget-radio {
      margin-top: 8px;
    }
    
    #${a} .widget-radio-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    
    #${a} .widget-radio-element {
      margin-right: 8px;
    }
    
    #${a} .widget-radio-submit {
      margin-top: 12px;
      padding: 8px 16px;
      background: var(--chat-primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s ease;
    }
    
    #${a} .widget-radio-submit:hover {
      background: var(--chat-primary-dark);
    }
    
    #${a} .widget-progress {
      margin-top: 8px;
    }
    
    #${a} .widget-progress-bar {
      width: 100%;
      height: 8px;
      background: var(--chat-border);
      border-radius: 4px;
      overflow: hidden;
    }
    
    #${a} .widget-progress-fill {
      height: 100%;
      background: var(--chat-primary);
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    #${a} .widget-progress-label {
      font-size: 14px;
      margin-bottom: 8px;
      color: var(--chat-text);
    }

    /* Color Picker Widget Styles */
    #${a} .widget-color-picker {
      margin-top: 8px;
      padding: 16px;
      background: var(--chat-surface);
      border-radius: 8px;
      border: 1px solid var(--chat-border);
    }
    
    #${a} .widget-color-label {
      display: block;
      margin-bottom: 12px;
      font-size: 14px;
      font-weight: 500;
      color: var(--chat-text);
    }
    
    #${a} .widget-color-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    #${a} .widget-color-input {
      width: 50px;
      height: 40px;
      border: 2px solid var(--chat-border);
      border-radius: 6px;
      cursor: pointer;
      background: var(--chat-bg);
      padding: 0;
    }
    
    #${a} .widget-color-input::-webkit-color-swatch-wrapper {
      padding: 0;
    }
    
    #${a} .widget-color-input::-webkit-color-swatch {
      border: none;
      border-radius: 4px;
    }
    
    #${a} .widget-color-display {
      flex: 1;
      padding: 8px 12px;
      background: var(--chat-bg);
      border: 1px solid var(--chat-border);
      border-radius: 6px;
      font-family: monospace;
      font-size: 14px;
      color: var(--chat-text);
      text-align: center;
    }
    
    #${a} .widget-color-presets {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    
    #${a} .widget-color-preset {
      width: 32px;
      height: 32px;
      border: 2px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    #${a} .widget-color-preset:hover {
      border-color: var(--chat-primary);
      transform: scale(1.1);
    }
    
    #${a} .widget-color-submit {
      width: 100%;
      padding: 10px 16px;
      background: var(--chat-bg);
      color: var(--chat-text);
      border: 1px solid var(--chat-border);
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    #${a} .widget-color-submit:hover:not(:disabled) {
      background: var(--chat-primary);
      color: white;
      border-color: var(--chat-primary);
    }
    
    #${a} .widget-color-input.widget-color-disabled,
    #${a} .widget-color-submit.widget-color-disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Waiting message styles */
    #${a} .waiting-message {
      background: var(--chat-surface);
      color: var(--chat-text);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      padding: 12px 16px;
      min-width: 60px;
    }

    #${a} .waiting-dots {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    #${a} .waiting-dots .dot {
      width: 8px;
      height: 8px;
      background: var(--chat-text);
      border-radius: 50%;
      opacity: 0.3;
      animation: waitingDotPulse 1.4s infinite ease-in-out both;
    }

    #${a} .waiting-dots .dot:nth-child(1) {
      animation-delay: -0.32s;
    }

    #${a} .waiting-dots .dot:nth-child(2) {
      animation-delay: -0.16s;
    }

    #${a} .waiting-dots .dot:nth-child(3) {
      animation-delay: 0s;
    }

    @keyframes waitingDotPulse {
      0%, 80%, 100% {
        opacity: 0.3;
        transform: scale(0.8);
      }
      40% {
        opacity: 1;
        transform: scale(1);
      }
    }
  `,document.head.appendChild(e)}function Y(a,t){let{displayMode:e,position:i,title:o,targetSelector:r}=t,s=document.createElement("div");s.id=a,s.className=e;let n=document.createElement("div");n.className="window",n.id=`${a}-window`,e==="popup"&&(n.style.cssText=`
      ${i.includes("bottom")?"bottom: 20px;":"top: 20px;"}
      ${i.includes("right")?"right: 20px;":"left: 20px;"}
    `),n.innerHTML=`
    <div class="header" id="${a}-header">
      <h3>${o}</h3>
      ${e==="popup"?`<button type="button" class="close" id="${a}-close" aria-label="Close chat">\xD7</button>`:""}
    </div>
    <div class="messages" id="${a}-messages" role="log" aria-live="polite" aria-atomic="false"></div>
    <div class="input">
      <textarea class="textarea" id="${a}-input" placeholder="Type your message... (Shift+Enter for new line)" rows="1" aria-label="Type a message"></textarea>
      <button type="button" class="send" id="${a}-send" aria-label="Send message">Send</button>
    </div>
  `;let d=null;if(e==="popup"&&(d=document.createElement("button"),d.className="button",d.id=`${a}-button`,d.type="button",d.setAttribute("aria-label","Toggle chat window"),d.style.cssText=`
      ${i.includes("bottom")?"bottom: 20px;":"top: 20px;"}
      ${i.includes("right")?"right: 20px;":"left: 20px;"}
    `,d.innerHTML=`
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z" fill="white"/>
      </svg>
    `,s.appendChild(d)),s.appendChild(n),e==="fullpage"&&r){let c=document.querySelector(r);c?c.appendChild(s):(console.error(`Target element "${r}" not found`),document.body.appendChild(s))}else document.body.appendChild(s);return{container:s,chatWindow:n,chatButton:d}}function Q(a,t,e,i,o=null){let r=document.createElement("div");r.className=`message ${e}-message`,r.id=`${i}-message-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;let s=document.createElement("div");if(s.innerHTML=t.replace(/\n/g,"<br>"),r.appendChild(s),o&&e==="bot"){let n=X(o,i);r.appendChild(n)}a.appendChild(r),a.scrollTop=a.scrollHeight}function X(a,t){let e=B.createWidget(a,t);return e?e.createElement():document.createComment(`Unsupported widget type: ${a?.type}`)}var R={default:{light:{primary:"#007bff",bg:"#ffffff",surface:"#f8f9fa",text:"#212529",border:"#e9ecef"},dark:{primary:"#4dabf7",bg:"#1a1a1a",surface:"#2d2d2d",text:"#ffffff",border:"#404040"}},branded:{light:{primary:"#6366f1",bg:"#ffffff",surface:"#f5f3ff",text:"#1e1b4b",border:"#e0e7ff"},dark:{primary:"#818cf8",bg:"#0f172a",surface:"#1e293b",text:"#f1f5f9",border:"#334155"}}},J=class{constructor(t,e){this.widgetId=t,this.scriptElement=e,this.storageKey=`chat-widget-${t}-theme`,this.modeStorageKey=`chat-widget-${t}-mode`}getThemeConfig(){let t=this.getTheme(),e=this.getMode(),i=this.getCustomColors(e),o=R[t]?.[e]||R.default[e];return{theme:t,mode:e,colors:{...o,...i}}}getTheme(){let t=localStorage.getItem(this.storageKey);if(t&&R[t])return t;if(this.scriptElement){let e=this.scriptElement.getAttribute("data-theme");if(e&&R[e])return e}return"default"}getMode(){let t=localStorage.getItem(this.modeStorageKey);if(t==="light"||t==="dark")return t;if(this.scriptElement){let e=this.scriptElement.getAttribute("data-theme-mode");if(e==="light"||e==="dark")return e;let i=this.scriptElement.getAttribute("data-mode");if(i==="light"||i==="dark")return i}return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}getCustomColors(t){if(!this.scriptElement)return{};let e={},i=t==="light"?"-light":"-dark",o={[`data-color${i}`]:"primary",[`data-bg-color${i}`]:"bg",[`data-surface-color${i}`]:"surface",[`data-text-color${i}`]:"text",[`data-border-color${i}`]:"border"},r={"data-color":"primary","data-bg-color":"bg","data-surface-color":"surface","data-text-color":"text","data-border-color":"border"};for(let[s,n]of Object.entries(o)){let d=this.scriptElement.getAttribute(s);d&&(e[n]=d)}for(let[s,n]of Object.entries(r)){let d=this.scriptElement.getAttribute(s);d&&!e[n]&&(e[n]=d)}return e}setTheme(t){if(!R[t]){console.warn(`Unknown theme: ${t}`);return}localStorage.setItem(this.storageKey,t)}setMode(t){if(t!=="light"&&t!=="dark"){console.warn(`Invalid mode: ${t}`);return}localStorage.setItem(this.modeStorageKey,t)}toggleMode(){let e=this.getMode()==="light"?"dark":"light";return this.setMode(e),e}watchSystemTheme(t){if(!window.matchMedia)return;let e=window.matchMedia("(prefers-color-scheme: dark)"),i=o=>{if(!localStorage.getItem(this.modeStorageKey)){let r=o.matches?"dark":"light";t(r)}};return e.addEventListener?e.addEventListener("change",i):e.addListener(i),()=>{e.removeEventListener?e.removeEventListener("change",i):e.removeListener(i)}}};var _=class{constructor(t){let e={},i=null;if(t instanceof HTMLElement&&t.tagName==="SCRIPT"){if(i=t,i._chatWidgetInitialized)return;i._chatWidgetInitialized=!0;let s=i.getAttribute("data-display")||null;e={id:i.id,displayMode:s,position:i.getAttribute("data-position"),primaryColor:i.getAttribute("data-color"),title:i.getAttribute("data-title"),targetSelector:i.getAttribute("data-target"),serverUrl:i.getAttribute("data-server-url"),forceJsonP:i.getAttribute("data-force-jsonp")==="true",preferJsonP:i.getAttribute("data-prefer-jsonp")==="true"}}else e=t||{};this.scriptElement=i,this.widgetId=e.id||"chat-widget-"+Math.random().toString(36).substr(2,9);let o=e.primaryColor||e.color;this.themeManager=new J(this.widgetId,i);let r=this.themeManager.getThemeConfig();this.config={displayMode:e.displayMode||e.mode||"popup",position:e.position||"bottom-right",primaryColor:o||r.colors.primary,explicitColor:o,title:e.title||"Chat with us",targetSelector:e.targetSelector||e.target||null,serverUrl:e.serverUrl||"http://localhost:3000",theme:r.theme,themeMode:r.mode,themeColors:r.colors},this.api=new K({serverUrl:this.config.serverUrl}),this.state={isOpen:!1,messages:[]},this.init(),this.scriptElement&&(this.scriptElement._chatWidgetInstance=this)}init(){q(this.widgetId,this.config);let{container:t,chatWindow:e,chatButton:i}=Y(this.widgetId,this.config);this.container=t,this.chatWindow=e,this.chatButton=i,this.container.setAttribute("data-theme",this.config.theme),this.container.setAttribute("data-mode",this.config.themeMode),this.applyCustomColors(),this.messagesContainer=this.chatWindow.querySelector(".messages"),this.textarea=this.chatWindow.querySelector(".textarea"),this.sendButton=this.chatWindow.querySelector(".send"),this.closeButton=this.chatWindow.querySelector(".close"),this.bindEvents(),this.api.performHandshake(),this.api.connect((o,r,s)=>this.addMessage(o,r,s)),document.addEventListener("widgetInteraction",o=>{o.detail.widgetId===this.widgetId&&this.handleWidgetInteraction(o.detail)}),this.themeManager.watchSystemTheme(o=>{this.setThemeMode(o)})}applyCustomColors(){if(this.scriptElement){let e=this.config.themeMode==="light"?"-light":"-dark",i={[`data-color${e}`]:"--chat-primary",[`data-bg-color${e}`]:"--chat-bg",[`data-surface-color${e}`]:"--chat-surface",[`data-text-color${e}`]:"--chat-text",[`data-border-color${e}`]:"--chat-border"},o={"data-color":"--chat-primary","data-bg-color":"--chat-bg","data-surface-color":"--chat-surface","data-text-color":"--chat-text","data-border-color":"--chat-border"};for(let[r,s]of Object.entries(i)){let n=this.scriptElement.getAttribute(r);n&&(this.container.style.setProperty(s,n),s==="--chat-primary"&&this.container.style.setProperty("--chat-primary-dark",v(n,-20)))}for(let[r,s]of Object.entries(o)){let n=this.scriptElement.getAttribute(r);n&&!this.container.style.getPropertyValue(s)&&(this.container.style.setProperty(s,n),s==="--chat-primary"&&this.container.style.setProperty("--chat-primary-dark",v(n,-20)))}}this.config.explicitColor&&!this.container.style.getPropertyValue("--chat-primary")&&(this.container.style.setProperty("--chat-primary",this.config.explicitColor),this.container.style.setProperty("--chat-primary-dark",v(this.config.explicitColor,-20)))}setState(t){this.state={...this.state,...t},this.render()}render(){this.state.isOpen?(this.chatWindow.classList.add("window-open"),this.chatButton&&(this._updateButtonPosition(!0),this.chatButton.style.display="none")):(this.chatWindow.classList.remove("window-open"),this.chatButton&&(this._updateButtonPosition(!1),this.chatButton.style.display="flex"))}bindEvents(){this.handlers={toggle:()=>this.toggle(),close:()=>this.close(),send:()=>this.sendMessage(),keypress:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),this.sendMessage())}},this.chatButton&&this.chatButton.addEventListener("click",this.handlers.toggle),this.closeButton&&this.closeButton.addEventListener("click",this.handlers.close),this.textarea.addEventListener("keypress",this.handlers.keypress),this.sendButton.addEventListener("click",this.handlers.send),this.setupTextareaAutoResize()}setupTextareaAutoResize(){this.textarea.style.height="auto",this.textarea.style.height=this.textarea.scrollHeight+"px";let t=new ResizeObserver(()=>{this.textarea.style.height="auto";let i=Math.min(this.textarea.scrollHeight,150);this.textarea.style.height=i+"px",this.textarea.style.overflowY=this.textarea.scrollHeight>150?"auto":"hidden"});t.observe(this.textarea),this.resizeObserver=t}toggle(){this.setState({isOpen:!this.state.isOpen})}open(){this.setState({isOpen:!0}),setTimeout(()=>{this.textarea&&this.textarea.focus()},100)}close(){this.setState({isOpen:!1})}_updateButtonPosition(t){let{position:e}=this.config;t?e.includes("bottom")&&e.includes("right")?this.chatButton.style.cssText="bottom: 520px; right: 20px;":e.includes("bottom")&&e.includes("left")?this.chatButton.style.cssText="bottom: 520px; left: 20px;":e.includes("top")&&e.includes("right")?this.chatButton.style.cssText="top: 20px; right: 380px;":e.includes("top")&&e.includes("left")&&(this.chatButton.style.cssText="top: 20px; left: 380px;"):this.chatButton.style.cssText=`
        ${e.includes("bottom")?"bottom: 20px;":"top: 20px;"}
        ${e.includes("right")?"right: 20px;":"left: 20px;"}
      `}sendMessage(t){let e=t||this.textarea.value.trim();if(e){this.addMessage(e,"user");let i=this.addWaitingMessage();this.api.sendMessage(e,(o,r,s)=>{this.removeWaitingMessage(i),this.addMessage(o,r,s)}),t||(this.textarea.value="",this.textarea.style.height="auto")}}handleWidgetInteraction(t){let e=t.optionText;this.addMessage(e,"user");let i=this.addWaitingMessage();this.api.sendMessage(t.optionValue,(o,r,s)=>{this.removeWaitingMessage(i),this.addMessage(o,r,s)})}addMessage(t,e,i=null){let o={text:t,sender:e,timestamp:Date.now(),widgetData:i};this.state.messages.push(o),Q(this.messagesContainer,t,e,this.widgetId,i)}addWaitingMessage(){let t=`${this.widgetId}-waiting-${Date.now()}`,e=document.createElement("div");e.className="message bot-message waiting-message",e.id=t;let i=document.createElement("div");return i.className="waiting-dots",i.innerHTML=`
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
    `,e.appendChild(i),this.messagesContainer.appendChild(e),this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight,t}removeWaitingMessage(t){let e=document.getElementById(t);e&&e.remove()}get ws(){return this.api.wsConnection}sendTypingIndicator(t){this.api.sendTypingIndicator&&this.api.sendTypingIndicator(t)}setTheme(t){this.themeManager.setTheme(t),this.container.setAttribute("data-theme",t),this.config.theme=t}setThemeMode(t){this.themeManager.setMode(t),this.container.setAttribute("data-mode",t),this.config.themeMode=t,this.applyCustomColors()}toggleThemeMode(){let t=this.themeManager.toggleMode();return this.container.setAttribute("data-mode",t),this.config.themeMode=t,this.applyCustomColors(),t}getThemeConfig(){return{theme:this.config.theme,mode:this.config.themeMode,colors:this.config.themeColors}}};window.createChatWidget=function(a){return new _(a)};window.ChatUI={init:function(a){return new _(a)}};document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll('script[id^="chat-widget"]').forEach(t=>{t.src&&t.src!==window.location.href||window.createChatWidget(t)})});var Z=new MutationObserver(function(a){a.forEach(function(t){t.addedNodes.forEach(function(e){if(e.nodeName==="SCRIPT"&&e.id&&e.id.startsWith("chat-widget")){if(e.src&&e.src!==window.location.href)return;window.createChatWidget(e)}})})});Z.observe(document.documentElement,{childList:!0,subtree:!0});document.currentScript&&document.currentScript.id&&document.currentScript.id.startsWith("chat-widget")&&window.createChatWidget(document.currentScript);})();
