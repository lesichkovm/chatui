(()=>{var z=class{constructor(t){this.serverUrl=t.serverUrl,this.debug=t.debug||!1}getSessionKey(){return localStorage.getItem("chat_session_key")||""}setSessionKey(t){localStorage.setItem("chat_session_key",t)}isTestEnvironment(){return typeof window<"u"&&window.location&&window.location.hostname==="localhost"&&window.location.port==="32000"}performHandshake(t){if(this.isTestEnvironment()){this.setSessionKey("test-session-key"),t&&t();return}let e="handshakeCallback_"+Date.now(),i=`${this.serverUrl}/api/handshake?callback=${e}`;this._injectScript(i,e,a=>{a.status==="success"&&(this.setSessionKey(a.session_key),t&&t())})}connect(t){if(this.isTestEnvironment())return;let e=this.getSessionKey(),i="connectCallback_"+Date.now(),a=`${this.serverUrl}/api/messages?callback=${i}&type=connect&session_key=${encodeURIComponent(e)}`;this._injectScript(a,i,n=>{t&&(n.widget?t(n.text,"bot",n.widget):t(n.text,"bot"))})}sendMessage(t,e){if(this.isTestEnvironment())return;let i=this.getSessionKey(),a="chatCallback_"+Date.now(),n=`${this.serverUrl}/api/messages?callback=${a}&message=${encodeURIComponent(t)}&type=message&session_key=${encodeURIComponent(i)}`;this._injectScript(n,a,s=>{e&&(s.widget?e(s.text,"bot",s.widget):e(s.text,"bot"))})}_injectScript(t,e,i){let a=document.createElement("script");a.src=t,a.onerror=()=>{console.error(`ChatWidget: Failed to load ${t}`),window[e]&&delete window[e],document.body.contains(a)&&document.body.removeChild(a)},window[e]=function(n){i(n),delete window[e],document.body.contains(a)&&document.body.removeChild(a)},document.body.appendChild(a)}};function F(d,t){return d.replace(/^#/,"").replace(/../g,e=>("0"+Math.min(255,Math.max(0,parseInt(e,16)+t)).toString(16)).substr(-2)).replace(/^/,"#")}var c=class{constructor(t,e){this.widgetData=t,this.widgetId=e}createElement(){throw new Error("createElement() must be implemented by subclass")}handleInteraction(t){let e=new CustomEvent("widgetInteraction",{detail:{widgetId:this.widgetId,...t}});document.dispatchEvent(e)}validate(){return this.widgetData&&this.widgetData.type}};var b=class extends c{createElement(){if(!this.validate())return document.createComment("Invalid buttons widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="buttons"&&this.widgetData.options){let e=document.createElement("div");e.className="widget-buttons",this.widgetData.options.forEach(i=>{let a=document.createElement("button");a.className="widget-button",a.textContent=i.text,a.setAttribute("data-widget-id",this.widgetId),a.setAttribute("data-option-id",i.id),a.setAttribute("data-option-value",i.value),a.addEventListener("click",()=>{e.querySelectorAll(".widget-button").forEach(s=>{s.disabled=!0,s.classList.add("widget-button-disabled")}),this.handleInteraction({optionId:i.id,optionValue:i.value,optionText:i.text,widgetType:"buttons"})}),e.appendChild(a)}),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="buttons"&&Array.isArray(this.widgetData.options)&&this.widgetData.options.length>0}};var x=class extends c{createElement(){if(!this.validate())return document.createComment("Invalid select widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="select"&&this.widgetData.options){let e=document.createElement("div");e.className="widget-select";let i=document.createElement("select");if(i.className="widget-select-element",i.setAttribute("data-widget-id",this.widgetId),this.widgetData.placeholder){let a=document.createElement("option");a.value="",a.textContent=this.widgetData.placeholder,a.disabled=!0,a.selected=!0,i.appendChild(a)}this.widgetData.options.forEach(a=>{let n=document.createElement("option");n.value=a.value,n.textContent=a.text,n.setAttribute("data-option-id",a.id),i.appendChild(n)}),i.addEventListener("change",()=>{let a=i.options[i.selectedIndex],n=this.widgetData.options.find(s=>s.id===a.getAttribute("data-option-id"));n&&(i.disabled=!0,i.classList.add("widget-select-disabled"),this.handleInteraction({optionId:n.id,optionValue:n.value,optionText:n.text,widgetType:"select"}))}),e.appendChild(i),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="select"&&Array.isArray(this.widgetData.options)&&this.widgetData.options.length>0}};var v=class extends c{createElement(){if(!this.validate())return document.createComment("Invalid input widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="input"){let e=document.createElement("div");e.className="widget-input";let i=document.createElement("input");i.type=this.widgetData.inputType||"text",i.className="widget-input-element",i.placeholder=this.widgetData.placeholder||"Enter your response...",i.setAttribute("data-widget-id",this.widgetId);let a=document.createElement("button");a.className="widget-input-submit",a.textContent=this.widgetData.buttonText||"Submit";let n=()=>{let s=i.value.trim();s&&(i.disabled=!0,i.classList.add("widget-input-disabled"),a.disabled=!0,a.classList.add("widget-input-disabled"),this.handleInteraction({optionId:"input-submit",optionValue:s,optionText:s,widgetType:"input"}),i.value="")};a.addEventListener("click",n),i.addEventListener("keypress",s=>{s.key==="Enter"&&(s.preventDefault(),n())}),e.appendChild(i),e.appendChild(a),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="input"}};var y=class extends c{createElement(){if(!this.validate())return document.createComment("Invalid checkbox widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="checkbox"&&this.widgetData.options){let e=document.createElement("div");e.className="widget-checkbox";let i=document.createElement("button");i.className="widget-checkbox-submit",i.textContent=this.widgetData.buttonText||"Submit",this.widgetData.options.forEach(n=>{let s=document.createElement("div");s.className="widget-checkbox-item";let o=document.createElement("input");o.type="checkbox",o.className="widget-checkbox-element",o.id=`checkbox-${this.widgetId}-${n.id}`,o.value=n.value,o.setAttribute("data-widget-id",this.widgetId),o.setAttribute("data-option-id",n.id),n.checked&&(o.checked=!0);let r=document.createElement("label");r.className="widget-checkbox-label",r.htmlFor=`checkbox-${this.widgetId}-${n.id}`,r.textContent=n.text,s.appendChild(o),s.appendChild(r),e.appendChild(s)});let a=()=>{let n=e.querySelectorAll(".widget-checkbox-element"),s=[];n.forEach(o=>{if(o.checked){let r=o.getAttribute("data-option-id"),l=this.widgetData.options.find(u=>u.id===r);l&&s.push({optionId:l.id,optionValue:l.value,optionText:l.text})}}),(s.length>0||this.widgetData.allowEmpty!==!1)&&(e.querySelectorAll(".widget-checkbox-element").forEach(r=>{r.disabled=!0,r.classList.add("widget-checkbox-disabled")}),i.disabled=!0,i.classList.add("widget-checkbox-disabled"),this.handleInteraction({selectedOptions:s,widgetType:"checkbox"}))};i.addEventListener("click",a),e.appendChild(i),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="checkbox"&&Array.isArray(this.widgetData.options)&&this.widgetData.options.length>0}};var C=class extends c{createElement(){if(!this.validate())return document.createComment("Invalid textarea widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="textarea"){let e=document.createElement("div");e.className="widget-textarea";let i=document.createElement("textarea");i.className="widget-textarea-element",i.placeholder=this.widgetData.placeholder||"Enter your response...",i.rows=this.widgetData.rows||4,i.setAttribute("data-widget-id",this.widgetId),this.widgetData.maxLength&&(i.maxLength=this.widgetData.maxLength);let a=document.createElement("button");a.className="widget-textarea-submit",a.textContent=this.widgetData.buttonText||"Submit";let n=()=>{let s=i.value.trim();s&&(i.disabled=!0,i.classList.add("widget-textarea-disabled"),a.disabled=!0,a.classList.add("widget-textarea-disabled"),this.handleInteraction({optionId:"textarea-submit",optionValue:s,optionText:s,widgetType:"textarea"}),i.value="")};a.addEventListener("click",n),i.addEventListener("keydown",s=>{s.key==="Enter"&&s.ctrlKey&&(s.preventDefault(),n())}),e.appendChild(i),e.appendChild(a),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="textarea"}};var E=class extends c{createElement(){if(!this.validate())return document.createComment("Invalid slider widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="slider"){let e=document.createElement("div");e.className="widget-slider";let i=document.createElement("label");i.className="widget-slider-label",i.textContent=this.widgetData.label||"Select a value";let a=document.createElement("div");a.className="widget-slider-wrapper";let n=document.createElement("input");n.type="range",n.className="widget-slider-element",n.min=this.widgetData.min||0,n.max=this.widgetData.max||100,n.step=this.widgetData.step||1,n.value=this.widgetData.defaultValue||Math.floor((n.min+n.max)/2),n.setAttribute("data-widget-id",this.widgetId);let s=document.createElement("div");s.className="widget-slider-value",s.textContent=n.value;let o=document.createElement("button");o.className="widget-slider-submit",o.textContent=this.widgetData.buttonText||"Submit",n.addEventListener("input",()=>{s.textContent=n.value});let r=()=>{let l=parseFloat(n.value);n.disabled=!0,n.classList.add("widget-slider-disabled"),o.disabled=!0,o.classList.add("widget-slider-disabled"),this.handleInteraction({optionId:"slider-submit",optionValue:l,optionText:l.toString(),widgetType:"slider"})};o.addEventListener("click",r),a.appendChild(n),a.appendChild(s),e.appendChild(i),e.appendChild(a),e.appendChild(o),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="slider"&&typeof this.widgetData.min=="number"&&typeof this.widgetData.max=="number"&&this.widgetData.max>this.widgetData.min}};var D=class extends c{createElement(){if(!this.validate())return document.createComment("Invalid rating widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="rating"){let e=document.createElement("div");e.className="widget-rating";let i=document.createElement("div");i.className="widget-rating-label",i.textContent=this.widgetData.label||"Rate this";let a=document.createElement("div");a.className="widget-rating-stars";let n=this.widgetData.maxRating||5,s=this.widgetData.iconType||"stars";for(let o=1;o<=n;o++){let r=document.createElement("button");r.className="widget-rating-star",r.setAttribute("data-rating",o),r.setAttribute("data-widget-id",this.widgetId),s==="emojis"?r.textContent="\u2B50":r.innerHTML="\u2605",r.addEventListener("mouseenter",()=>{this.highlightStars(a,o)}),r.addEventListener("mouseleave",()=>{this.resetStars(a)}),r.addEventListener("click",()=>{this.selectRating(a,o),a.querySelectorAll(".widget-rating-star").forEach(u=>{u.disabled=!0,u.classList.add("widget-rating-disabled")}),this.handleInteraction({optionId:"rating-submit",optionValue:o,optionText:`${o} star${o>1?"s":""}`,widgetType:"rating"})}),a.appendChild(r)}e.appendChild(i),e.appendChild(a),t.appendChild(e)}return t}highlightStars(t,e){t.querySelectorAll(".widget-rating-star").forEach((a,n)=>{n<e?a.classList.add("widget-rating-star-hover"):a.classList.remove("widget-rating-star-hover")})}resetStars(t){t.querySelectorAll(".widget-rating-star").forEach(i=>{i.classList.remove("widget-rating-star-hover")})}selectRating(t,e){t.querySelectorAll(".widget-rating-star").forEach((a,n)=>{n<e?a.classList.add("widget-rating-star-selected"):a.classList.remove("widget-rating-star-selected")})}validate(){return super.validate()&&this.widgetData.type==="rating"&&typeof this.widgetData.maxRating=="number"&&this.widgetData.maxRating>0}};var k=class extends c{createElement(){if(!this.validate())return document.createComment("Invalid toggle widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="toggle"){let e=document.createElement("div");e.className="widget-toggle";let i=document.createElement("label");i.className="widget-toggle-label",i.textContent=this.widgetData.label||"Enable";let a=document.createElement("div");a.className="widget-toggle-wrapper";let n=document.createElement("input");n.type="checkbox",n.className="widget-toggle-input",n.setAttribute("data-widget-id",this.widgetId),this.widgetData.defaultValue===!0&&(n.checked=!0);let s=document.createElement("span");s.className="widget-toggle-slider";let o=document.createElement("button");o.className="widget-toggle-submit",o.textContent=this.widgetData.buttonText||"Submit";let r=()=>{let l=n.checked;n.disabled=!0,n.classList.add("widget-toggle-disabled"),o.disabled=!0,o.classList.add("widget-toggle-disabled"),this.handleInteraction({optionId:"toggle-submit",optionValue:l,optionText:l?"enabled":"disabled",widgetType:"toggle"})};o.addEventListener("click",r),a.appendChild(n),a.appendChild(s),e.appendChild(i),e.appendChild(a),e.appendChild(o),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="toggle"}};var N=class extends c{createElement(){if(!this.validate())return document.createComment("Invalid date widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="date"){let e=document.createElement("div");e.className="widget-date";let i=document.createElement("label");i.className="widget-date-label",i.textContent=this.widgetData.label||"Select a date";let a=document.createElement("input");a.type="date",a.className="widget-date-element",a.setAttribute("data-widget-id",this.widgetId),this.widgetData.minDate&&(a.min=this.widgetData.minDate),this.widgetData.maxDate&&(a.max=this.widgetData.maxDate),this.widgetData.placeholder&&(a.placeholder=this.widgetData.placeholder);let n=document.createElement("button");n.className="widget-date-submit",n.textContent=this.widgetData.buttonText||"Submit";let s=()=>{let o=a.value;o&&(a.disabled=!0,a.classList.add("widget-date-disabled"),n.disabled=!0,n.classList.add("widget-date-disabled"),this.handleInteraction({optionId:"date-submit",optionValue:o,optionText:o,widgetType:"date"}))};n.addEventListener("click",s),a.addEventListener("keypress",o=>{o.key==="Enter"&&(o.preventDefault(),s())}),e.appendChild(i),e.appendChild(a),e.appendChild(n),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="date"}};var $=class extends c{createElement(){if(!this.validate())return document.createComment("Invalid tags widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="tags"){let e=document.createElement("div");e.className="widget-tags";let i=document.createElement("label");i.className="widget-tags-label",i.textContent=this.widgetData.label||"Add tags";let a=document.createElement("div");a.className="widget-tags-input-wrapper";let n=document.createElement("div");n.className="widget-tags-display";let s=document.createElement("input");s.type="text",s.className="widget-tags-input",s.placeholder=this.widgetData.placeholder||"Type and press Enter to add tag",s.setAttribute("data-widget-id",this.widgetId);let o=document.createElement("ul");o.className="widget-tags-suggestions",o.style.display="none";let r=this.widgetData.maxTags||10,l=[],u=()=>{n.innerHTML="",l.forEach((m,g)=>{let p=document.createElement("span");p.className="widget-tag",p.textContent=m;let w=document.createElement("button");w.className="widget-tag-remove",w.textContent="\xD7",w.addEventListener("click",()=>{l.splice(g,1),u()}),p.appendChild(w),n.appendChild(p)})},f=m=>{if(!this.widgetData.suggestions||!m){o.style.display="none";return}let g=this.widgetData.suggestions.filter(p=>p.toLowerCase().includes(m.toLowerCase())&&!l.includes(p));g.length>0?(o.innerHTML="",g.forEach(p=>{let w=document.createElement("li");w.className="widget-tags-suggestion",w.textContent=p,w.addEventListener("click",()=>{l.length<r&&(l.push(p),u(),s.value="",o.style.display="none")}),o.appendChild(w)}),o.style.display="block"):o.style.display="none"};s.addEventListener("input",()=>{f(s.value)}),s.addEventListener("keydown",m=>{if(m.key==="Enter"){m.preventDefault();let g=s.value.trim();g&&l.length<r&&!l.includes(g)&&(l.push(g),u(),s.value="",o.style.display="none")}else m.key==="Backspace"&&!s.value&&l.length>0&&(l.pop(),u())});let h=document.createElement("button");h.className="widget-tags-submit",h.textContent=this.widgetData.buttonText||"Submit";let U=()=>{l.length>0&&(s.disabled=!0,s.classList.add("widget-tags-disabled"),h.disabled=!0,h.classList.add("widget-tags-disabled"),this.handleInteraction({optionId:"tags-submit",optionValue:l,optionText:l.join(", "),widgetType:"tags"}))};h.addEventListener("click",U),a.appendChild(n),a.appendChild(s),a.appendChild(o),e.appendChild(i),e.appendChild(a),e.appendChild(h),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="tags"}};var L=class extends c{createElement(){if(!this.validate())return document.createComment("Invalid file upload widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="file"){let e=document.createElement("div");e.className="widget-file-upload";let i=document.createElement("label");i.className="widget-file-label",i.textContent=this.widgetData.label||"Upload a file";let a=document.createElement("div");a.className="widget-file-dropzone";let n=document.createElement("div");n.className="widget-file-dropzone-content",n.innerHTML=`
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        <p>Drag and drop files here or click to select</p>
      `;let s=document.createElement("input");s.type="file",s.className="widget-file-input",s.setAttribute("data-widget-id",this.widgetId),s.style.display="none",this.widgetData.accept&&(s.accept=this.widgetData.accept),this.widgetData.maxFiles&&(s.multiple=this.widgetData.maxFiles>1);let o=document.createElement("div");o.className="widget-file-list";let r=[],l=this.widgetData.maxFiles||1,u=this.widgetData.maxSize||10*1024*1024,f=()=>{o.innerHTML="",r.forEach((m,g)=>{let p=document.createElement("div");p.className="widget-file-item";let w=document.createElement("span");w.className="widget-file-name",w.textContent=m.name;let H=document.createElement("span");H.className="widget-file-size",H.textContent=this.formatFileSize(m.size);let I=document.createElement("button");I.className="widget-file-remove",I.textContent="\xD7",I.addEventListener("click",()=>{r.splice(g,1),f()}),p.appendChild(w),p.appendChild(H),p.appendChild(I),o.appendChild(p)})};a.addEventListener("click",()=>{s.click()}),a.addEventListener("dragover",m=>{m.preventDefault(),a.classList.add("widget-file-dropzone-active")}),a.addEventListener("dragleave",()=>{a.classList.remove("widget-file-dropzone-active")}),a.addEventListener("drop",m=>{m.preventDefault(),a.classList.remove("widget-file-dropzone-active");let g=Array.from(m.dataTransfer.files);this.addFiles(g)}),s.addEventListener("change",()=>{let m=Array.from(s.files);this.addFiles(m),s.value=""}),this.addFiles=m=>{m.forEach(g=>{if(!(r.length>=l)){if(g.size>u){alert(`File ${g.name} exceeds maximum size of ${this.formatFileSize(u)}`);return}r.some(p=>p.name===g.name)||r.push(g)}}),f()};let h=document.createElement("button");h.className="widget-file-submit",h.textContent=this.widgetData.buttonText||"Upload";let U=()=>{if(r.length>0){let m=r.map(p=>({name:p.name,size:p.size,type:p.type}));a.classList.add("widget-file-disabled"),h.disabled=!0,h.classList.add("widget-file-disabled");let g=r.map(p=>p.name).join(", ");this.handleInteraction({optionId:"file-upload",optionValue:m,optionText:g||`${r.length} file(s)`,widgetType:"file"})}};h.addEventListener("click",U),a.appendChild(n),e.appendChild(i),e.appendChild(a),e.appendChild(o),e.appendChild(h),e.appendChild(s),t.appendChild(e)}return t}formatFileSize(t){if(t===0)return"0 Bytes";let e=1024,i=["Bytes","KB","MB","GB"],a=Math.floor(Math.log(t)/Math.log(e));return Math.round(t/Math.pow(e,a)*100)/100+" "+i[a]}validate(){return super.validate()&&this.widgetData.type==="file"}};var S=class extends c{createElement(){if(!this.validate())return document.createComment("Invalid color picker widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="color"){let e=document.createElement("div");e.className="widget-color-picker";let i=document.createElement("label");i.className="widget-color-label",i.textContent=this.widgetData.label||"Select a color";let a=document.createElement("div");a.className="widget-color-wrapper";let n=document.createElement("input");n.type="color",n.className="widget-color-input",n.setAttribute("data-widget-id",this.widgetId),this.widgetData.defaultColor&&(n.value=this.widgetData.defaultColor);let s=document.createElement("div");s.className="widget-color-display",s.style.backgroundColor=n.value,s.textContent=n.value.toUpperCase();let o=document.createElement("div");o.className="widget-color-presets",this.widgetData.presetColors&&this.widgetData.presetColors.length>0&&this.widgetData.presetColors.forEach(u=>{let f=document.createElement("button");f.className="widget-color-preset",f.style.backgroundColor=u,f.setAttribute("data-color",u),f.addEventListener("click",()=>{n.value=u,s.style.backgroundColor=u,s.textContent=u.toUpperCase()}),o.appendChild(f)});let r=document.createElement("button");r.className="widget-color-submit",r.textContent=this.widgetData.buttonText||"Submit",n.addEventListener("input",()=>{s.style.backgroundColor=n.value,s.textContent=n.value.toUpperCase()});let l=()=>{let u=n.value;n.disabled=!0,n.classList.add("widget-color-disabled"),r.disabled=!0,r.classList.add("widget-color-disabled"),this.handleInteraction({optionId:"color-submit",optionValue:u,optionText:u.toUpperCase(),widgetType:"color"})};r.addEventListener("click",l),a.appendChild(n),a.appendChild(s),e.appendChild(i),e.appendChild(a),this.widgetData.presetColors&&this.widgetData.presetColors.length>0&&e.appendChild(o),e.appendChild(r),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="color"}};var T=class extends c{createElement(){if(!this.validate())return document.createComment("Invalid confirmation widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="confirmation"){let e=document.createElement("div");e.className="widget-confirmation";let i=document.createElement("div");i.className="widget-confirmation-message",i.textContent=this.widgetData.message||"Are you sure?";let a=document.createElement("div");a.className="widget-confirmation-buttons";let n=document.createElement("button");n.className="widget-confirmation-cancel",n.textContent=this.widgetData.cancelText||"Cancel";let s=document.createElement("button");s.className="widget-confirmation-confirm",s.textContent=this.widgetData.confirmText||"Confirm";let o=()=>{n.disabled=!0,n.classList.add("widget-confirmation-disabled"),s.disabled=!0,s.classList.add("widget-confirmation-disabled"),this.handleInteraction({optionId:"confirmation-cancel",optionValue:!1,optionText:"cancelled",widgetType:"confirmation"})},r=()=>{n.disabled=!0,n.classList.add("widget-confirmation-disabled"),s.disabled=!0,s.classList.add("widget-confirmation-disabled"),this.handleInteraction({optionId:"confirmation-confirm",optionValue:!0,optionText:"confirmed",widgetType:"confirmation"})};n.addEventListener("click",o),s.addEventListener("click",r),a.appendChild(n),a.appendChild(s),e.appendChild(i),e.appendChild(a),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="confirmation"&&this.widgetData.message}};var W=class extends c{createElement(){if(!this.validate())return document.createComment("Invalid radio widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="radio"&&this.widgetData.options){let e=document.createElement("div");e.className="widget-radio";let i=document.createElement("button");i.className="widget-radio-submit",i.textContent=this.widgetData.buttonText||"Submit",this.widgetData.options.forEach(n=>{let s=document.createElement("div");s.className="widget-radio-item";let o=document.createElement("input");o.type="radio",o.name=`radio-${this.widgetId}`,o.className="widget-radio-element",o.id=`radio-${this.widgetId}-${n.id}`,o.value=n.value,o.setAttribute("data-widget-id",this.widgetId),o.setAttribute("data-option-id",n.id),n.checked&&(o.checked=!0);let r=document.createElement("label");r.className="widget-radio-label",r.htmlFor=`radio-${this.widgetId}-${n.id}`,r.textContent=n.text,s.appendChild(o),s.appendChild(r),e.appendChild(s)});let a=()=>{let n=e.querySelector(".widget-radio-element:checked");if(n){let s=n.getAttribute("data-option-id"),o=this.widgetData.options.find(r=>r.id===s);o&&(e.querySelectorAll(".widget-radio-element").forEach(l=>{l.disabled=!0,l.classList.add("widget-radio-disabled")}),i.disabled=!0,i.classList.add("widget-radio-disabled"),this.handleInteraction({optionId:o.id,optionValue:o.value,optionText:o.text,widgetType:"radio"}))}};i.addEventListener("click",a),e.appendChild(i),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="radio"&&Array.isArray(this.widgetData.options)&&this.widgetData.options.length>0}};var B=class extends c{createElement(){if(!this.validate())return document.createComment("Invalid progress widget data");let t=document.createElement("div");if(t.className="widget",this.widgetData.type==="progress"){let e=document.createElement("div");e.className="widget-progress";let i=document.createElement("div");i.className="widget-progress-label",i.textContent=this.widgetData.label||"Progress";let a=document.createElement("div");a.className="widget-progress-bar-wrapper";let n=document.createElement("div");n.className="widget-progress-bar";let s=this.widgetData.value||0,o=this.widgetData.max||100,r=Math.min(Math.max(s/o*100,0),100);n.style.width=`${r}%`;let l=document.createElement("div");l.className="widget-progress-text",l.textContent=`${s} / ${o}`,this.widgetData.showPercentage!==!1&&(l.textContent+=` (${Math.round(r)}%)`),a.appendChild(n),e.appendChild(i),e.appendChild(a),e.appendChild(l),t.appendChild(e)}return t}validate(){return super.validate()&&this.widgetData.type==="progress"&&typeof this.widgetData.value=="number"&&typeof this.widgetData.max=="number"&&this.widgetData.max>0}};var A=class{static widgetTypes=new Map([["buttons",b],["select",x],["input",v],["checkbox",y],["textarea",C],["slider",E],["rating",D],["toggle",k],["date",N],["tags",$],["file",L],["color",S],["confirmation",T],["radio",W],["progress",B]]);static registerWidget(t,e){this.widgetTypes.set(t,e)}static createWidget(t,e){if(!t||!t.type)return console.warn("Invalid widget data:",t),null;let i=this.widgetTypes.get(t.type);if(!i)return console.warn(`Unsupported widget type: ${t.type}`),null;try{return new i(t,e)}catch(a){return console.error(`Error creating widget of type ${t.type}:`,a),null}}static getSupportedTypes(){return Array.from(this.widgetTypes.keys())}};function R(d,t,e){let i=document.createElement("style");i.textContent=`
    /* Scope all styles to the widget ID */
    #${d} {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      /* Add CSS variables scoped to this widget */
      --chat-primary-color: ${t};
      --chat-primary-color-dark: ${F(t,-20)};
    }

    /* Scoped CSS Reset */
    #${d} * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      line-height: 1.5;
    }
    
    #${d} .button {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      background-color: var(--chat-primary-color);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease;
      position: fixed;
      z-index: 10000;
    }
    
    #${d} .button:hover {
      transform: scale(1.1);
      background-color: var(--chat-primary-color-dark);
    }
    
    #${d} .window {
      display: none;
      width: 350px;
      height: 500px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 5px 40px rgba(0, 0, 0, 0.16);
      flex-direction: column;
      overflow: hidden;
      position: fixed;
      z-index: 9998;
    }

    #${d}.fullpage {
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    #${d}.fullpage .window {
      position: relative;
      display: flex;
      width: 100%;
      height: 100%;
      border-radius: 0;
      box-shadow: none;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }
    
    #${d} .window-open {
      display: flex;
    }
    
    #${d} .header {
      padding: 16px;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    
    #${d} .header h3 {
      margin: 0;
      font-size: 16px;
      color: #212529;
    }
    
    #${d} .close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6c757d;
      padding: 0;
      line-height: 1;
      display: ${e==="fullpage"?"none":"block"};
    }
    
    #${d} .messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }
    
    #${d} .message {
      max-width: 80%;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    #${d} .user-message {
      background: var(--chat-primary-color);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    
    #${d} .bot-message {
      background: #f1f3f5;
      color: #212529;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    
    #${d} .input {
      padding: 16px;
      border-top: 1px solid #e9ecef;
      display: flex;
      gap: 8px;
      align-items: flex-end;
      flex-shrink: 0;
      background: white;
    }
    
    #${d} .textarea {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
      resize: none;
      min-height: 38px;
      max-height: 150px;
      font-family: inherit;
      line-height: 1.4;
      overflow-y: auto; /* Allow scrolling in textarea */
    }
    
    #${d} .textarea:focus {
      border-color: var(--chat-primary-color);
    }
    
    #${d} .send {
      padding: 8px 16px;
      background: var(--chat-primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s ease;
      height: 38px;
      white-space: nowrap;
    }
    
    #${d} .send:hover {
      background: var(--chat-primary-color-dark);
    }
    
    #${d} .widget {
      margin-top: 8px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }
    
    #${d} .widget-buttons {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    #${d} .widget-button {
      padding: 8px 12px;
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      text-align: left;
      transition: all 0.2s ease;
    }
    
    #${d} .widget-button:hover {
      background: var(--chat-primary-color);
      color: white;
      border-color: var(--chat-primary-color);
    }
    
    #${d} .widget-button:active {
      transform: translateY(1px);
    }
    
    #${d} .widget-button:disabled,
    #${d} .widget-button-disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: #f8f9fa;
      color: #6c757d;
      border-color: #dee2e6;
    }
    
    #${d} .widget-button:disabled:hover,
    #${d} .widget-button-disabled:hover {
      background: #f8f9fa;
      color: #6c757d;
      border-color: #dee2e6;
      transform: none;
    }
    
    #${d} .widget-select {
      margin-top: 8px;
    }
    
    #${d} .widget-select-element {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      outline: none;
      cursor: pointer;
    }
    
    #${d} .widget-select-element:focus {
      border-color: var(--chat-primary-color);
    }
    
    #${d} .widget-select-element:disabled,
    #${d} .widget-select-disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: #f8f9fa;
      color: #6c757d;
    }
    
    #${d} .widget-select-element:disabled:hover,
    #${d} .widget-select-disabled:hover {
      background: #f8f9fa;
      border-color: #dee2e6;
    }
    
    #${d} .widget-input {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    #${d} .widget-input-element {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
    }
    
    #${d} .widget-input-element:focus {
      border-color: var(--chat-primary-color);
    }
    
    #${d} .widget-input-submit {
      padding: 8px 16px;
      background: var(--chat-primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s ease;
    }
    
    #${d} .widget-input-submit:hover {
      background: var(--chat-primary-color-dark);
    }
    
    #${d} .widget-input-element:disabled,
    #${d} .widget-input-element.widget-input-disabled,
    #${d} .widget-input-submit:disabled,
    #${d} .widget-input-submit.widget-input-disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: #f8f9fa;
      color: #6c757d;
      border-color: #dee2e6;
    }
    
    #${d} .widget-input-element:disabled:hover,
    #${d} .widget-input-element.widget-input-disabled:hover,
    #${d} .widget-input-submit:disabled:hover,
    #${d} .widget-input-submit.widget-input-disabled:hover {
      background: #f8f9fa;
      border-color: #dee2e6;
    }
  `,document.head.appendChild(i)}function V(d,t){let{mode:e,position:i,title:a,targetSelector:n}=t,s=document.createElement("div");s.id=d,s.className=e;let o=document.createElement("div");o.className="window",o.id=`${d}-window`,e==="popup"&&(o.style.cssText=`
      ${i.includes("bottom")?"bottom: 20px;":"top: 20px;"}
      ${i.includes("right")?"right: 20px;":"left: 20px;"}
    `),o.innerHTML=`
    <div class="header" id="${d}-header">
      <h3>${a}</h3>
      ${e==="popup"?`<button type="button" class="close" id="${d}-close" aria-label="Close chat">\xD7</button>`:""}
    </div>
    <div class="messages" id="${d}-messages" role="log" aria-live="polite" aria-atomic="false"></div>
    <div class="input">
      <textarea class="textarea" id="${d}-input" placeholder="Type your message... (Shift+Enter for new line)" rows="1" aria-label="Type a message"></textarea>
      <button type="button" class="send" id="${d}-send" aria-label="Send message">Send</button>
    </div>
  `;let r=null;if(e==="popup"&&(r=document.createElement("button"),r.className="button",r.id=`${d}-button`,r.type="button",r.setAttribute("aria-label","Toggle chat window"),r.style.cssText=`
      ${i.includes("bottom")?"bottom: 20px;":"top: 20px;"}
      ${i.includes("right")?"right: 20px;":"left: 20px;"}
    `,r.innerHTML=`
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2Z" fill="white"/>
      </svg>
    `,s.appendChild(r)),s.appendChild(o),e==="fullpage"&&n){let l=document.querySelector(n);l?l.appendChild(s):(console.error(`Target element "${n}" not found`),document.body.appendChild(s))}else document.body.appendChild(s);return{container:s,chatWindow:o,chatButton:r}}function O(d,t,e,i,a=null){let n=document.createElement("div");n.className=`message ${e}-message`,n.id=`${i}-message-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;let s=document.createElement("div");if(s.innerHTML=t.replace(/\n/g,"<br>"),n.appendChild(s),a&&e==="bot"){let o=_(a,i);n.appendChild(o)}d.appendChild(n),d.scrollTop=d.scrollHeight}function _(d,t){let e=A.createWidget(d,t);return e?e.createElement():document.createComment(`Unsupported widget type: ${d?.type}`)}var M=class{constructor(t){let e={},i=null;if(t instanceof HTMLElement&&t.tagName==="SCRIPT"){if(i=t,i._chatWidgetInitialized)return;i._chatWidgetInitialized=!0,e={id:i.id,mode:i.getAttribute("data-mode"),position:i.getAttribute("data-position"),primaryColor:i.getAttribute("data-color"),title:i.getAttribute("data-title"),targetSelector:i.getAttribute("data-target"),serverUrl:i.getAttribute("data-server-url")}}else e=t||{};this.scriptElement=i,this.widgetId=e.id||"chat-widget-"+Math.random().toString(36).substr(2,9),this.config={mode:e.mode||"popup",position:e.position||"bottom-right",primaryColor:e.primaryColor||e.color||"#007bff",title:e.title||"Chat with us",targetSelector:e.targetSelector||e.target||null,serverUrl:e.serverUrl||"http://localhost:3000"},this.api=new z({serverUrl:this.config.serverUrl}),this.state={isOpen:!1,messages:[]},this.init()}init(){R(this.widgetId,this.config.primaryColor,this.config.mode);let{container:t,chatWindow:e,chatButton:i}=V(this.widgetId,this.config);this.container=t,this.chatWindow=e,this.chatButton=i,this.messagesContainer=this.chatWindow.querySelector(".messages"),this.textarea=this.chatWindow.querySelector(".textarea"),this.sendButton=this.chatWindow.querySelector(".send"),this.closeButton=this.chatWindow.querySelector(".close"),this.bindEvents(),this.api.performHandshake(),this.api.connect((a,n,s)=>this.addMessage(a,n,s)),document.addEventListener("widgetInteraction",a=>{a.detail.widgetId===this.widgetId&&this.handleWidgetInteraction(a.detail)})}setState(t){this.state={...this.state,...t},this.render()}render(){this.state.isOpen?(this.chatWindow.classList.add("window-open"),this.chatButton&&(this._updateButtonPosition(!0),this.chatButton.style.display="none")):(this.chatWindow.classList.remove("window-open"),this.chatButton&&(this._updateButtonPosition(!1),this.chatButton.style.display="flex"))}bindEvents(){this.handlers={toggle:()=>this.toggle(),close:()=>this.close(),send:()=>this.sendMessage(),keypress:t=>{t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),this.sendMessage())}},this.chatButton&&this.chatButton.addEventListener("click",this.handlers.toggle),this.closeButton&&this.closeButton.addEventListener("click",this.handlers.close),this.textarea.addEventListener("keypress",this.handlers.keypress),this.sendButton.addEventListener("click",this.handlers.send),this.setupTextareaAutoResize()}setupTextareaAutoResize(){this.textarea.style.height="auto",this.textarea.style.height=this.textarea.scrollHeight+"px";let t=new ResizeObserver(()=>{this.textarea.style.height="auto";let i=Math.min(this.textarea.scrollHeight,150);this.textarea.style.height=i+"px",this.textarea.style.overflowY=this.textarea.scrollHeight>150?"auto":"hidden"});t.observe(this.textarea),this.resizeObserver=t}toggle(){this.setState({isOpen:!this.state.isOpen})}open(){this.setState({isOpen:!0}),setTimeout(()=>{this.textarea&&this.textarea.focus()},100)}close(){this.setState({isOpen:!1})}_updateButtonPosition(t){let{position:e}=this.config;t?e.includes("bottom")&&e.includes("right")?this.chatButton.style.cssText="bottom: 520px; right: 20px;":e.includes("bottom")&&e.includes("left")?this.chatButton.style.cssText="bottom: 520px; left: 20px;":e.includes("top")&&e.includes("right")?this.chatButton.style.cssText="top: 20px; right: 380px;":e.includes("top")&&e.includes("left")&&(this.chatButton.style.cssText="top: 20px; left: 380px;"):this.chatButton.style.cssText=`
        ${e.includes("bottom")?"bottom: 20px;":"top: 20px;"}
        ${e.includes("right")?"right: 20px;":"left: 20px;"}
      `}sendMessage(t){let e=t||this.textarea.value.trim();e&&(this.addMessage(e,"user"),this.api.sendMessage(e,(i,a,n)=>this.addMessage(i,a,n)),t||(this.textarea.value="",this.textarea.style.height="auto"))}handleWidgetInteraction(t){let e=t.optionText;this.addMessage(e,"user"),this.api.sendMessage(t.optionValue,(i,a,n)=>this.addMessage(i,a,n))}addMessage(t,e,i=null){let a={text:t,sender:e,timestamp:Date.now(),widgetData:i};this.state.messages.push(a),O(this.messagesContainer,t,e,this.widgetId,i)}};window.createChatWidget=function(d){return new M(d)};window.ChatUI={init:function(d){return new M(d)}};document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll('script[id^="chat-widget"]').forEach(t=>{t.src&&t.src!==window.location.href||window.createChatWidget(t)})});var j=new MutationObserver(function(d){d.forEach(function(t){t.addedNodes.forEach(function(e){if(e.nodeName==="SCRIPT"&&e.id&&e.id.startsWith("chat-widget")){if(e.src&&e.src!==window.location.href)return;window.createChatWidget(e)}})})});j.observe(document.documentElement,{childList:!0,subtree:!0});document.currentScript&&document.currentScript.id&&document.currentScript.id.startsWith("chat-widget")&&window.createChatWidget(document.currentScript);})();
